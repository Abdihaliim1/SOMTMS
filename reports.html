<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1e3a8a;
        }

        .text-navy {
            color: #1e3a8a;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .metric-card {
            transition: transform 0.2s ease-in-out;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #ffffff;
        }

        .main-content {
            margin-left: 250px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1e3a8a;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Sidebar Navigation -->
    <div class="sidebar fixed left-0 top-0 h-full text-white z-50">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="company-logo" id="companyLogo">ST</div>
                <div>
                    <h2 class="text-xl font-bold" id="companyName">ATS FREIGHT LLC</h2>
                    <p class="text-sm opacity-75">TMS</p>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="index.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    Dashboard
                </a>
                <a href="loads.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck mr-3 w-5"></i>
                    Loads
                </a>
                <a href="drivers.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-users mr-3 w-5"></i>
                    Drivers
                </a>
                <a href="fleet.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck-monster mr-3 w-5"></i>
                    Fleet
                </a>
                <a href="customers.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-building mr-3 w-5"></i>
                    Customers
                </a>
                <a href="expenses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-receipt mr-3 w-5"></i>
                    Expenses
                </a>
                <a href="invoices.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-file-invoice mr-3 w-5"></i>
                    Invoices
                </a>
                <a href="settlements.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-calculator mr-3 w-5"></i>
                    Settlements
                </a>
                <a href="reports.html"
                    class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-chart-bar mr-3 w-5"></i>
                    Reports
                </a>
                <a href="import.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-upload mr-3 w-5"></i>
                    Import
                </a>
            </nav>
        </div>

        <div class="absolute bottom-6 left-6 right-6">
            <button onclick="CompanySettings.openModal()"
                class="w-full flex items-center px-4 py-3 rounded-lg text-sm font-medium bg-white bg-opacity-10 hover:bg-opacity-20 transition-all">
                <i class="fas fa-cog mr-3 w-5"></i>
                Company Settings
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Business Reports</h1>
                        <p class="text-gray-600">Comprehensive analytics and performance metrics</p>
                    </div>
                    <div class="flex space-x-3">
                        <select id="reportPeriod"
                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <button onclick="ReportManager.exportReport()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Tabs -->
        <div class="bg-white border-b border-gray-200">
            <div class="px-6">
                <nav class="flex space-x-8">
                    <button onclick="ReportManager.switchTab('overview')" id="overviewTab"
                        class="py-4 px-1 border-b-2 border-blue-600 font-medium text-sm text-blue-600">
                        Overview
                    </button>
                    <button onclick="ReportManager.switchTab('revenue')" id="revenueTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Revenue
                    </button>
                    <button onclick="ReportManager.switchTab('expenses')" id="expensesTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Expenses
                    </button>
                    <button onclick="ReportManager.switchTab('drivers')" id="driversTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Driver Performance
                    </button>
                    <button onclick="ReportManager.switchTab('customers')" id="customersTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Customer Analysis
                    </button>
                </nav>
            </div>
        </div>

        <!-- Report Content -->
        <div class="p-6">
            <!-- Overview Tab -->
            <div id="overviewContent" class="tab-content">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-bold text-green-600" id="totalRevenue">$0</p>
                                <p class="text-sm text-gray-500">+12.5% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Miles</p>
                                <p class="text-2xl font-bold text-blue-600" id="totalMiles">0</p>
                                <p class="text-sm text-gray-500">+8.3% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-road text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Loads Completed</p>
                                <p class="text-2xl font-bold text-purple-600" id="loadsCompleted">0</p>
                                <p class="text-sm text-gray-500">+15.2% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-truck text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Net Profit</p>
                                <p class="text-2xl font-bold text-orange-600" id="netProfit">$0</p>
                                <p class="text-sm text-gray-500"><span id="profitMargin">0%</span> margin</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-orange-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profit Breakdown -->
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Profit Breakdown</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-700 font-medium">Total Revenue</span>
                            <span class="text-green-600 font-bold text-lg" id="breakdownRevenue">$0</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-700">Total Expenses</span>
                            <span class="text-red-600 font-semibold" id="breakdownExpenses">$0</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-700">Driver Pay</span>
                            <span class="text-red-600 font-semibold" id="breakdownDriverPay">$0</span>
                        </div>
                        <div class="flex justify-between items-center py-3 bg-gray-50 rounded-lg px-4 mt-4">
                            <span class="text-gray-900 font-bold text-lg">Net Profit</span>
                            <span class="font-bold text-xl" id="breakdownNetProfit">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Trend</h3>
                        <div id="revenueChart" style="height: 300px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Load Status Distribution</h3>
                        <div id="loadStatusChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="revenueContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Monthly Revenue</h3>
                        <div id="monthlyRevenueChart" style="height: 400px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue by Customer</h3>
                        <div id="customerRevenueChart" style="height: 400px;"></div>
                    </div>
                </div>

                <div class="mt-6 bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Details</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Period</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Miles</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Avg Rate/Mile</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Revenue data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expensesContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Breakdown</h3>
                        <div id="expenseBreakdownChart" style="height: 400px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Trends</h3>
                        <div id="expenseTrendChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Driver Performance Tab -->
            <div id="driversContent" class="tab-content hidden">
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Driver Performance Metrics</h3>
                    <div id="driverPerformanceChart" style="height: 400px;"></div>
                </div>

                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Driver Rankings</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Driver</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Miles</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Performance</th>
                                </tr>
                            </thead>
                            <tbody id="driverTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Driver data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customer Analysis Tab -->
            <div id="customersContent" class="tab-content hidden">
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Revenue Analysis</h3>
                    <div id="customerAnalysisChart" style="height: 400px;"></div>
                </div>

                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Customers</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Customer</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Avg Rate</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Payment Terms</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Customer data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="main.js"></script>
    <script>
        // Report Manager Module
        const ReportManager = {
            currentTab: 'overview',
            data: {},

            // Initialize reports
            init: () => {
                ReportManager.calculateRealData();
                ReportManager.switchTab('overview');
                ReportManager.setupEventListeners();
            },

            // Calculate real data from DataManager
            calculateRealData: () => {
                const invoices = DataManager.invoices || [];
                let loads = DataManager.loads || [];
                let expenses = DataManager.expenses || [];
                const drivers = DataManager.drivers || [];
                const customers = DataManager.customers || [];
                let settlements = DataManager.settlements || [];

                console.log('[Reports] Calculating data:', {
                    loads: loads.length,
                    expenses: expenses.length,
                    settlements: settlements.length,
                    drivers: drivers.length,
                    customers: customers.length
                });

                // Filter by selected period
                const period = document.getElementById('reportPeriod')?.value || 'month';
                const now = new Date();
                let startDate;

                switch (period) {
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                    default:
                        startDate = null;
                }

                // Filter loads by period (use appropriate date based on status)
                if (startDate) {
                    loads = loads.filter(load => {
                        const status = (load.status || '').toLowerCase().replace(' ', '_');
                        // For delivered loads, use delivery date; for others use pickup or creation date
                        let loadDate;
                        if (status === 'delivered' || status === 'completed') {
                            loadDate = new Date(load.deliveredAt || load.delivery?.date || load.createdAt);
                        } else {
                            loadDate = new Date(load.pickedUpAt || load.pickup?.date || load.createdAt);
                        }
                        return loadDate >= startDate && loadDate <= now;
                    });
                }

                // Filter expenses by period
                if (startDate) {
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date || exp.createdAt);
                        return expDate >= startDate && expDate <= now;
                    });
                }

                // Filter settlements by period
                if (startDate) {
                    settlements = settlements.filter(st => {
                        const stDate = new Date(st.period?.startDate || st.createdAt);
                        return stDate >= startDate && stDate <= now;
                    });
                }

                // 1. Revenue: Sum of all load prices from booked, in_transit, and delivered loads
                const revenueLoads = loads.filter(l => {
                    const status = (l.status || '').toLowerCase().replace(' ', '_');
                    return status === 'booked' || status === 'in_transit' || status === 'delivered' || 
                           status === 'completed' || status === 'dispatched';
                });
                const totalRevenue = revenueLoads.reduce((sum, l) => sum + (parseFloat(l.rate?.total || l.rate || 0) || 0), 0);

                // 2. Total Miles: Sum of all miles from booked, in_transit, and delivered loads
                const totalMiles = revenueLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);

                // 3. Loads Completed: Number of completed/delivered loads only
                const completedLoads = loads.filter(l => {
                    const status = (l.status || '').toLowerCase().replace(' ', '_');
                    return status === 'delivered' || status === 'completed';
                });
                const loadsCompleted = completedLoads.length;

                // 4. Driver Pay (Sum of net pay from all settlements)
                const totalDriverPay = settlements.reduce((sum, st) => sum + (parseFloat(st.netPay) || 0), 0);

                // 5. Expenses (Sum of all tracked expenses)
                const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);

                // 6. Net Profit = Revenue - Driver Pay - Expenses
                const netProfit = totalRevenue - totalDriverPay - totalExpenses;

                // 7. Profit Margin = (Net Profit / Revenue) Ã— 100
                const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;

                // 8. Monthly Revenue (Group revenue loads by month - booked, in_transit, delivered)
                const monthlyRevenue = Array(12).fill(0);
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                revenueLoads.forEach(load => {
                    const date = new Date(load.deliveredAt || load.delivery?.date || load.pickedUpAt || load.createdAt);
                    const month = date.getMonth(); // 0-11
                    if (!isNaN(month)) {
                        monthlyRevenue[month] += (parseFloat(load.rate?.total || load.rate || 0) || 0);
                    }
                });

                // 6. Load Status
                const statusCounts = {
                    'delivered': 0,
                    'in_transit': 0,
                    'available': 0,
                    'cancelled': 0
                };
                loads.forEach(l => {
                    const s = l.status.toLowerCase().replace(' ', '_');
                    if (statusCounts[s] !== undefined) statusCounts[s]++;
                    else if (s === 'completed') statusCounts['delivered']++;
                    else if (s === 'pending') statusCounts['available']++;
                });

                // 7. Driver Performance
                const driverStats = drivers.map(d => {
                    const driverLoads = completedLoads.filter(l => String(l.driverId) === String(d.id));
                    const miles = driverLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);
                    const revenue = driverLoads.reduce((sum, l) => sum + (parseFloat(l.rate?.total || l.rate || 0) || 0), 0);
                    const loadCount = driverLoads.length;
                    // Simple performance score logic
                    const performance = loadCount > 0 ? Math.min(100, 80 + (loadCount * 2)) : 80;

                    return {
                        name: `${d.firstName || d.personalInfo?.firstName || ''} ${d.lastName || d.personalInfo?.lastName || ''}`,
                        miles,
                        revenue,
                        loads: loadCount,
                        performance
                    };
                }).sort((a, b) => b.revenue - a.revenue);

                // 8. Customer Analysis
                const customerStats = customers.map(c => {
                    const custLoads = completedLoads.filter(l => String(l.customerId) === String(c.id));
                    const revenue = custLoads.reduce((sum, l) => sum + (parseFloat(l.rate?.total || l.rate || 0) || 0), 0);
                    const loadCount = custLoads.length;
                    const totalMiles = custLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);
                    const avgRate = totalMiles > 0 ? (revenue / totalMiles).toFixed(2) : '0.00';

                    return {
                        name: c.company?.name || c.name || 'Unknown',
                        revenue,
                        loads: loadCount,
                        avgRate,
                        terms: c.financial?.paymentTerms || 'Net 30'
                    };
                }).sort((a, b) => b.revenue - a.revenue);

                // 9. Expense Breakdown (Group by actual expense types)
                const expenseByType = {};
                expenses.forEach(exp => {
                    const type = exp.type || 'other';
                    const amount = parseFloat(exp.amount) || 0;
                    expenseByType[type] = (expenseByType[type] || 0) + amount;
                });

                // Map expense types to display labels
                const typeLabels = {
                    'fuel': 'Fuel',
                    'maintenance': 'Maintenance',
                    'insurance': 'Insurance',
                    'toll': 'Tolls',
                    'lumper': 'Lumper Fees',
                    'other': 'Other'
                };

                const expenseLabels = [];
                const expenseValues = [];
                Object.entries(expenseByType).forEach(([type, amount]) => {
                    expenseLabels.push(typeLabels[type] || type.charAt(0).toUpperCase() + type.slice(1));
                    expenseValues.push(amount);
                });

                // If no expenses, show placeholder
                const expenseBreakdown = {
                    labels: expenseLabels.length > 0 ? expenseLabels : ['No Expenses'],
                    values: expenseValues.length > 0 ? expenseValues : [0]
                };

                ReportManager.data = {
                    revenue: totalRevenue,
                    miles: totalMiles,
                    loads: loadsCompleted,
                    driverPay: totalDriverPay,
                    expenses: totalExpenses,
                    netProfit: netProfit,
                    profitMargin,
                    revenueLoads: revenueLoads, // Store for revenue table calculations
                    completedLoads: completedLoads, // Store for driver/customer analysis
                    monthlyRevenue: {
                        labels: monthLabels,
                        values: monthlyRevenue
                    },
                    loadStatus: {
                        labels: ['Delivered', 'In Transit', 'Available', 'Cancelled'],
                        values: [
                            statusCounts['delivered'],
                            statusCounts['in_transit'],
                            statusCounts['available'],
                            statusCounts['cancelled']
                        ]
                    },
                    expenseBreakdown,
                    drivers: driverStats,
                    customers: customerStats
                };
            },

            // Switch tabs
            switchTab: (tabName) => {
                ReportManager.currentTab = tabName;

                // Update tab styles
                document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                    tab.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700';
                });
                document.getElementById(tabName + 'Tab').className = 'py-4 px-1 border-b-2 border-blue-600 font-medium text-sm text-blue-600';

                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + 'Content').classList.remove('hidden');

                // Load tab content
                ReportManager.loadTabContent(tabName);
            },

            // Load tab content
            loadTabContent: (tabName) => {
                switch (tabName) {
                    case 'overview':
                        ReportManager.loadOverview();
                        break;
                    case 'revenue':
                        ReportManager.loadRevenue();
                        break;
                    case 'expenses':
                        ReportManager.loadExpenses();
                        break;
                    case 'drivers':
                        ReportManager.loadDrivers();
                        break;
                    case 'customers':
                        ReportManager.loadCustomers();
                        break;
                }
            },

            // Load overview tab
            loadOverview: () => {
                // Update metrics
                document.getElementById('totalRevenue').textContent = Utils.formatCurrency(ReportManager.data.revenue);
                document.getElementById('totalMiles').textContent = ReportManager.data.miles.toLocaleString();
                document.getElementById('loadsCompleted').textContent = ReportManager.data.loads;
                document.getElementById('netProfit').textContent = Utils.formatCurrency(ReportManager.data.netProfit);
                document.getElementById('profitMargin').textContent = ReportManager.data.profitMargin + '%';

                // Update profit breakdown
                const breakdownRevenue = document.getElementById('breakdownRevenue');
                const breakdownExpenses = document.getElementById('breakdownExpenses');
                const breakdownDriverPay = document.getElementById('breakdownDriverPay');
                const breakdownNetProfit = document.getElementById('breakdownNetProfit');

                if (breakdownRevenue) breakdownRevenue.textContent = Utils.formatCurrency(ReportManager.data.revenue);
                if (breakdownExpenses) breakdownExpenses.textContent = Utils.formatCurrency(ReportManager.data.expenses);
                if (breakdownDriverPay) breakdownDriverPay.textContent = Utils.formatCurrency(ReportManager.data.driverPay);
                if (breakdownNetProfit) {
                    breakdownNetProfit.textContent = Utils.formatCurrency(ReportManager.data.netProfit);
                    // Color code profit (green if positive, red if negative)
                    breakdownNetProfit.className = ReportManager.data.netProfit >= 0 
                        ? 'font-bold text-xl text-green-600' 
                        : 'font-bold text-xl text-red-600';
                }

                // Revenue trend chart
                const revenueTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: ReportManager.data.monthlyRevenue.values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Revenue',
                    line: { color: '#3b82f6', width: 3 },
                    marker: { size: 8 }
                };

                Plotly.newPlot('revenueChart', [revenueTrace], {
                    title: '',
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Revenue ($)' },
                    margin: { t: 20, r: 20, b: 50, l: 60 }
                }, { responsive: true });

                // Load status chart
                const loadStatusTrace = {
                    labels: ReportManager.data.loadStatus.labels,
                    values: ReportManager.data.loadStatus.values,
                    type: 'pie',
                    marker: {
                        colors: ['#10b981', '#3b82f6', '#6b7280', '#ef4444']
                    }
                };

                Plotly.newPlot('loadStatusChart', [loadStatusTrace], {
                    title: '',
                    margin: { t: 20, r: 20, b: 20, l: 20 }
                }, { responsive: true });
            },

            // Load revenue tab
            loadRevenue: () => {
                // Monthly revenue chart
                const monthlyTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: ReportManager.data.monthlyRevenue.values,
                    type: 'bar',
                    name: 'Revenue',
                    marker: { color: '#3b82f6' }
                };

                Plotly.newPlot('monthlyRevenueChart', [monthlyTrace], {
                    title: '',
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Revenue ($)' },
                    margin: { t: 20, r: 20, b: 50, l: 60 }
                }, { responsive: true });

                // Customer revenue chart
                const customerTrace = {
                    x: ReportManager.data.customers.map(c => c.name),
                    y: ReportManager.data.customers.map(c => c.revenue),
                    type: 'bar',
                    name: 'Revenue',
                    marker: { color: '#10b981' }
                };

                Plotly.newPlot('customerRevenueChart', [customerTrace], {
                    title: '',
                    xaxis: { title: 'Customer' },
                    yaxis: { title: 'Revenue ($)' },
                    margin: { t: 20, r: 20, b: 80, l: 60 }
                }, { responsive: true });

                // Revenue table - calculate actual monthly data from revenue loads (booked, in_transit, delivered)
                const tbody = document.getElementById('revenueTableBody');
                tbody.innerHTML = '';

                const currentYear = new Date().getFullYear();
                const monthlyData = {};

                // Use revenueLoads (booked, in_transit, delivered) for revenue table
                const revenueLoads = ReportManager.data.revenueLoads || [];
                revenueLoads.forEach(load => {
                    const date = new Date(load.deliveredAt || load.delivery?.date || load.pickedUpAt || load.createdAt);
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    
                    if (year === currentYear && !isNaN(month)) {
                        if (!monthlyData[month]) {
                            monthlyData[month] = { revenue: 0, loads: 0, miles: 0 };
                        }
                        monthlyData[month].revenue += parseFloat(load.rate?.total || load.rate || 0) || 0;
                        monthlyData[month].loads += 1;
                        monthlyData[month].miles += parseFloat(load.mileage?.total || load.miles || 0) || 0;
                    }
                });

                ReportManager.data.monthlyRevenue.labels.forEach((month, index) => {
                    const data = monthlyData[index] || { revenue: 0, loads: 0, miles: 0 };
                    if (data.revenue > 0 || data.loads > 0) {
                        const ratePerMile = data.miles > 0 ? (data.revenue / data.miles).toFixed(2) : '0.00';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${month} ${currentYear}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(data.revenue)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.loads}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.miles.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${ratePerMile}</td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            },

            // Load expenses tab
            loadExpenses: () => {
                // Expense breakdown chart
                const expenseTrace = {
                    labels: ReportManager.data.expenseBreakdown.labels,
                    values: ReportManager.data.expenseBreakdown.values,
                    type: 'pie',
                    marker: {
                        colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']
                    }
                };

                Plotly.newPlot('expenseBreakdownChart', [expenseTrace], {
                    title: '',
                    margin: { t: 20, r: 20, b: 20, l: 20 }
                }, { responsive: true });

                // Expense trend chart (Calculate actual monthly expenses)
                const monthlyExpenses = Array(12).fill(0);
                expenses.forEach(exp => {
                    const date = new Date(exp.date || exp.createdAt);
                    const month = date.getMonth();
                    if (!isNaN(month)) {
                        monthlyExpenses[month] += parseFloat(exp.amount) || 0;
                    }
                });

                const trendTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: monthlyExpenses,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Expenses',
                    line: { color: '#ef4444', width: 3 },
                    marker: { size: 8 }
                };

                Plotly.newPlot('expenseTrendChart', [trendTrace], {
                    title: '',
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Expenses ($)' },
                    margin: { t: 20, r: 20, b: 50, l: 60 }
                }, { responsive: true });
            },

            // Load drivers tab
            loadDrivers: () => {
                // Driver performance chart
                const performanceTrace = {
                    x: ReportManager.data.drivers.map(d => d.name),
                    y: ReportManager.data.drivers.map(d => d.performance),
                    type: 'bar',
                    name: 'Performance Score',
                    marker: { color: '#3b82f6' }
                };

                Plotly.newPlot('driverPerformanceChart', [performanceTrace], {
                    title: '',
                    xaxis: { title: 'Driver' },
                    yaxis: { title: 'Performance Score' },
                    margin: { t: 20, r: 20, b: 80, l: 60 }
                }, { responsive: true });

                // Driver table
                const tbody = document.getElementById('driverTableBody');
                tbody.innerHTML = '';

                ReportManager.data.drivers.forEach(driver => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${driver.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.miles.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(driver.revenue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.loads}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${driver.performance}%"></div>
                                </div>
                                <span class="text-sm text-gray-900">${driver.performance}%</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Load customers tab
            loadCustomers: () => {
                // Customer analysis chart
                const analysisTrace = {
                    x: ReportManager.data.customers.map(c => c.name),
                    y: ReportManager.data.customers.map(c => c.revenue),
                    type: 'bar',
                    name: 'Revenue',
                    marker: { color: '#10b981' }
                };

                Plotly.newPlot('customerAnalysisChart', [analysisTrace], {
                    title: '',
                    xaxis: { title: 'Customer' },
                    yaxis: { title: 'Revenue ($)' },
                    margin: { t: 20, r: 20, b: 80, l: 60 }
                }, { responsive: true });

                // Customer table
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = '';

                ReportManager.data.customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(customer.revenue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.loads}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${customer.avgRate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.terms}</td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Export report
            exportReport: () => {
                Utils.showNotification('Report export feature coming soon', 'info');
            },

            // Setup event listeners
            setupEventListeners: () => {
                document.getElementById('reportPeriod').addEventListener('change', (e) => {
                    // Recalculate data based on selected period
                    ReportManager.calculateRealData();
                    ReportManager.loadTabContent(ReportManager.currentTab);
                    Utils.showNotification(`Reports updated for ${e.target.value}`, 'info');
                });
            }
        };

        // Auto-refresh reports when data changes (connected to DataManager listeners)
        window.renderLoads = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to loads change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderExpenses = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to expenses change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderSettlements = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to settlements change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderDrivers = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to drivers change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.updateDashboard = () => {
            // Dashboard updates can also trigger report refresh if needed
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to dashboard update');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for DataManager to load all data from Firebase first
            await DataManager.init();
            // Then initialize reports with the loaded data
            ReportManager.init();
        });
    </script>
</body>

</html>