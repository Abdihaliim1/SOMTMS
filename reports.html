<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1f2937;
        }

        .text-navy {
            color: #1f2937;
        }

        .gradient-bg {
            background-color: #1f2937;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .metric-card {
            transition: transform 0.2s ease-in-out;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar {
            width: 250px;
            background-color: #1f2937;
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ffffff;
        }

        .main-content {
            margin-left: 250px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }

        /* Print styles */
        @media print {
            .sidebar {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
            }

            button {
                display: none !important;
            }

            select {
                border: none !important;
                background: transparent !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Sidebar Navigation -->
    <div class="sidebar fixed left-0 top-0 h-full text-white z-50">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="company-logo" id="companyLogo">ST</div>
                <div>
                    <h2 class="text-xl font-bold" id="companyName">ATS FREIGHT LLC</h2>
                    <p class="text-sm opacity-75">TMS</p>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="index.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    Dashboard
                </a>
                <a href="loads.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck mr-3 w-5"></i>
                    Loads
                </a>
                <a href="drivers.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-users mr-3 w-5"></i>
                    Drivers
                </a>
                <a href="fleet.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-truck-monster mr-3 w-5"></i>
                    Fleet
                </a>
                <a href="customers.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-building mr-3 w-5"></i>
                    Customers
                </a>
                <a href="expenses.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-receipt mr-3 w-5"></i>
                    Expenses
                </a>
                <a href="invoices.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-file-invoice mr-3 w-5"></i>
                    Invoices
                </a>
                <a href="settlements.html"
                    class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-calculator mr-3 w-5"></i>
                    Settlements
                </a>
                <a href="reports.html"
                    class="sidebar-item active flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-chart-bar mr-3 w-5"></i>
                    Reports
                </a>
                <a href="import.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg text-sm font-medium">
                    <i class="fas fa-upload mr-3 w-5"></i>
                    Import
                </a>
            </nav>
        </div>

        <div class="absolute bottom-6 left-6 right-6">
            <button onclick="CompanySettings.openModal()"
                class="w-full flex items-center px-4 py-3 rounded-lg text-sm font-medium bg-white bg-opacity-10 hover:bg-opacity-20 transition-all">
                <i class="fas fa-cog mr-3 w-5"></i>
                Company Settings
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Business Reports</h1>
                        <p class="text-gray-600">Comprehensive analytics and performance metrics</p>
                    </div>
                    <div class="flex space-x-3">
                        <select id="reportPeriod"
                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="all_time">All Time</option>
                        </select>
                        <button onclick="ReportManager.printReport()"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-print mr-2"></i>
                            Print
                        </button>
                        <button onclick="ReportManager.exportReport()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Tabs -->
        <div class="bg-white border-b border-gray-200">
            <div class="px-6">
                <nav class="flex space-x-8">
                    <button onclick="ReportManager.switchTab('overview')" id="overviewTab"
                        class="py-4 px-1 border-b-2 border-blue-600 font-medium text-sm text-blue-600">
                        Overview
                    </button>
                    <button onclick="ReportManager.switchTab('revenue')" id="revenueTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Revenue
                    </button>
                    <button onclick="ReportManager.switchTab('expenses')" id="expensesTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Expenses
                    </button>
                    <button onclick="ReportManager.switchTab('drivers')" id="driversTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Driver Performance
                    </button>
                    <button onclick="ReportManager.switchTab('customers')" id="customersTab"
                        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Customer Analysis
                    </button>
                </nav>
            </div>
        </div>

        <!-- Report Content -->
        <div class="p-6">
            <!-- Overview Tab -->
            <div id="overviewContent" class="tab-content">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-bold text-green-600" id="totalRevenue">$0</p>
                                <p class="text-sm text-gray-500">+12.5% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Miles</p>
                                <p class="text-2xl font-bold text-blue-600" id="totalMiles">0</p>
                                <p class="text-sm text-gray-500">+8.3% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-road text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Loads Completed</p>
                                <p class="text-2xl font-bold text-purple-600" id="loadsCompleted">0</p>
                                <p class="text-sm text-gray-500">+15.2% from last month</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-truck text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Net Profit</p>
                                <p class="text-2xl font-bold text-orange-600" id="netProfit">$0</p>
                                <p class="text-sm text-gray-500"><span id="profitMargin">0%</span> margin</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-orange-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profit Breakdown -->
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Profit Breakdown</h3>
                    <div class="space-y-4">
                        <!-- Revenue Section -->
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-700 font-medium">Total Revenue</span>
                                <span class="text-green-600 font-bold text-lg" id="breakdownRevenue">$0</span>
                            </div>
                            <div class="pl-4 space-y-1 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Company Driver Loads</span>
                                    <span class="text-green-600" id="breakdownRevenueCompany">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Owner Operator Loads (Commission)</span>
                                    <span class="text-green-600" id="breakdownRevenueOO">$0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Expenses Section -->
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-700 font-medium">Total Expenses</span>
                                <span class="text-red-600 font-semibold" id="breakdownExpenses">$0</span>
                            </div>
                            <div class="pl-4 space-y-1 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Fuel</span>
                                    <span class="text-red-600" id="breakdownExpenseFuel">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Insurance</span>
                                    <span class="text-red-600" id="breakdownExpenseInsurance">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Maintenance</span>
                                    <span class="text-red-600" id="breakdownExpenseMaintenance">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Truck Payments (Leases/Loans)</span>
                                    <span class="text-red-600" id="breakdownExpenseTruckPayments">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Fixed Expenses</span>
                                    <span class="text-red-600" id="breakdownExpenseFixed">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Other</span>
                                    <span class="text-red-600" id="breakdownExpenseOther">$0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Driver Pay Section -->
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-700 font-medium">Driver Pay</span>
                                <span class="text-red-600 font-semibold" id="breakdownDriverPay">$0</span>
                            </div>
                            <div class="pl-4 space-y-1 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Company Drivers</span>
                                    <span class="text-red-600" id="breakdownDriverPayCompany">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Owner Operators</span>
                                    <span class="text-red-600" id="breakdownDriverPayOO">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Owner (as Driver)</span>
                                    <span class="text-red-600" id="breakdownDriverPayOwner">$0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Net Profit -->
                        <div class="flex justify-between items-center py-3 bg-gray-50 rounded-lg px-4 mt-4">
                            <div>
                                <span class="text-gray-900 font-bold text-lg">Net Profit</span>
                                <p class="text-xs text-gray-500 mt-1">Owner gets this as distribution (salary already in
                                    driver pay)</p>
                            </div>
                            <span class="font-bold text-xl" id="breakdownNetProfit">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Trend</h3>
                        <div id="revenueChart" style="height: 300px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Load Status Distribution</h3>
                        <div id="loadStatusChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="revenueContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Monthly Revenue</h3>
                        <div id="monthlyRevenueChart" style="height: 400px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue by Customer</h3>
                        <div id="customerRevenueChart" style="height: 400px;"></div>
                    </div>
                </div>

                <div class="mt-6 bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Details</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Period</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Miles</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Avg Rate/Mile</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Revenue data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expensesContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Breakdown</h3>
                        <div id="expenseBreakdownChart" style="height: 400px;"></div>
                    </div>

                    <div class="bg-white rounded-lg p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Trends</h3>
                        <div id="expenseTrendChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Driver Performance Tab -->
            <div id="driversContent" class="tab-content hidden">
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Driver Performance Metrics</h3>
                    <div id="driverPerformanceChart" style="height: 400px;"></div>
                </div>

                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Driver Rankings</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Driver</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Miles</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Performance</th>
                                </tr>
                            </thead>
                            <tbody id="driverTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Driver data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customer Analysis Tab -->
            <div id="customersContent" class="tab-content hidden">
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Revenue Analysis</h3>
                    <div id="customerAnalysisChart" style="height: 400px;"></div>
                </div>

                <div class="bg-white rounded-lg p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Customers</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Customer</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Revenue</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Loads</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Avg Rate</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Payment Terms</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Customer data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="main.js"></script>
    <script src="populate-mock-data.js"></script>
    <script>
        // Report Manager Module
        const ReportManager = {
            currentTab: 'overview',
            data: {},

            // Initialize reports
            init: () => {
                ReportManager.calculateRealData();
                ReportManager.switchTab('overview');
                ReportManager.setupEventListeners();
            },

            // Calculate real data from DataManager
            calculateRealData: () => {
                const invoices = DataManager.invoices || [];
                let loads = DataManager.loads || [];
                let expenses = DataManager.expenses || [];
                const drivers = DataManager.drivers || [];
                const customers = DataManager.customers || [];
                let settlements = DataManager.settlements || [];

                console.log('[Reports] Calculating data:', {
                    loads: loads.length,
                    expenses: expenses.length,
                    settlements: settlements.length,
                    drivers: drivers.length,
                    customers: customers.length
                });

                // Filter by selected period
                const period = document.getElementById('reportPeriod')?.value || 'month';
                const now = new Date();
                let startDate;

                switch (period) {
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                    case 'all_time':
                        startDate = null; // No date filter - show all data
                        break;
                    default:
                        startDate = null;
                }

                // Filter loads by period (use appropriate date based on status)
                if (startDate) {
                    loads = loads.filter(load => {
                        const status = (load.status || '').toLowerCase().replace(' ', '_');
                        // For delivered loads, use delivery date; for others use pickup or creation date
                        let loadDate;
                        if (status === 'delivered' || status === 'completed') {
                            loadDate = new Date(load.deliveredAt || load.delivery?.date || load.createdAt);
                        } else {
                            loadDate = new Date(load.pickedUpAt || load.pickup?.date || load.createdAt);
                        }
                        return loadDate >= startDate && loadDate <= now;
                    });
                }

                // Filter expenses by period
                if (startDate) {
                    const expensesBeforeFilter = expenses.length;
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date || exp.createdAt);
                        // Include expenses within the period OR future-dated expenses (for mock data)
                        // This allows mock data with future dates to still be included
                        if (expDate > now) {
                            // Future-dated expense (likely mock data) - include it
                            return true;
                        }
                        // Normal date filtering
                        const inRange = expDate >= startDate && expDate <= now;
                        return inRange;
                    });
                    console.log(`[Reports] Expenses filtered by date: ${expensesBeforeFilter} -> ${expenses.length} (period: ${period}, startDate: ${startDate?.toISOString()}, now: ${now.toISOString()})`);
                } else {
                    console.log(`[Reports] No date filter (all_time), showing all ${expenses.length} expenses`);
                }

                // Filter settlements by period
                if (startDate) {
                    settlements = settlements.filter(st => {
                        const stDate = new Date(st.period?.startDate || st.createdAt);
                        return stDate >= startDate && stDate <= now;
                    });
                }

                // 1. Revenue: Break down by driver type
                const revenueLoads = loads.filter(l => {
                    const status = (l.status || '').toLowerCase().replace(' ', '_');
                    return status === 'booked' || status === 'in_transit' || status === 'delivered' ||
                        status === 'completed' || status === 'dispatched';
                });

                // Calculate revenue by driver type
                let companyDriverRevenue = 0;
                let ownerOperatorRevenue = 0;

                revenueLoads.forEach(load => {
                    const revenue = parseFloat(load.companyRevenue || load.rate?.total || load.rate || 0) || 0;
                    if (load.driverId) {
                        const driver = drivers.find(d => d.id === load.driverId);
                        if (driver) {
                            if (driver.driverType === 'owner_operator') {
                                ownerOperatorRevenue += revenue;
                            } else {
                                // Company driver or owner (driver)
                                companyDriverRevenue += revenue;
                            }
                        } else {
                            // Driver not found, count as company driver revenue
                            companyDriverRevenue += revenue;
                        }
                    } else {
                        // No driver assigned, count as company driver revenue
                        companyDriverRevenue += revenue;
                    }
                });

                const totalRevenue = companyDriverRevenue + ownerOperatorRevenue;

                // 2. Total Miles: Sum of all miles from booked, in_transit, and delivered loads
                const totalMiles = revenueLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);

                // 3. Loads Completed: Number of completed/delivered loads only
                const completedLoads = loads.filter(l => {
                    const status = (l.status || '').toLowerCase().replace(' ', '_');
                    return status === 'delivered' || status === 'completed';
                });
                const loadsCompleted = completedLoads.length;

                // 4. Driver Pay (Break down by driver type)
                // Calculate from revenueLoads (accrued expense) instead of settlements (cash basis)
                let companyDriverPay = 0;
                let ownerOperatorPay = 0;
                let ownerAsDriverPay = 0;

                revenueLoads.forEach(load => {
                    let pay = parseFloat(load.rate?.driverPay) || 0;

                    // If driverPay not set on load, estimate it based on driver settings
                    if (!pay && load.driverId) {
                        const driver = drivers.find(d => d.id === load.driverId);
                        if (driver && driver.payment) {
                            const totalRate = parseFloat(load.companyRevenue || load.rate?.total || load.rate || 0) || 0;
                            const miles = parseFloat(load.mileage?.total || load.miles || 0) || 0;

                            if (driver.payment.type === 'percentage') {
                                // Use driver.payPercentage (decimal 0-1)
                                // Handle case where it might be stored as whole number (e.g. 75 instead of 0.75)
                                let pct = parseFloat(driver.payPercentage) || 0.75;
                                if (pct > 1) pct = pct / 100;
                                pay = totalRate * pct;
                            } else if (driver.payment.type === 'per_mile') {
                                const ratePerMile = parseFloat(driver.payment.perMileRate) || 0.65;
                                pay = miles * ratePerMile;
                            }
                        }
                    }

                    if (load.driverId) {
                        const driver = drivers.find(d => d.id === load.driverId);
                        if (driver) {
                            if (driver.driverType === 'owner_operator') {
                                ownerOperatorPay += pay;
                            } else if (driver.driverType === 'owner') {
                                ownerAsDriverPay += pay;
                            } else {
                                companyDriverPay += pay;
                            }
                        } else {
                            companyDriverPay += pay;
                        }
                    } else {
                        companyDriverPay += pay;
                    }
                });

                const totalDriverPay = companyDriverPay + ownerOperatorPay + ownerAsDriverPay;

                // 5. Expenses (Break down by category - exclude O/O-paid expenses)
                // Only count expenses paid by company or tracked_only (not owner_operator)
                const companyExpenses = expenses.filter(exp => {
                    const paidBy = exp.paidBy || 'company'; // Default to company if not set
                    return paidBy !== 'owner_operator'; // Exclude O/O-paid expenses from P&L
                });

                // Break down expenses by category
                let fuelExpenses = 0;
                let insuranceExpenses = 0;
                let maintenanceExpenses = 0;
                let fixedExpenses = 0;
                let truckPayments = 0;
                let otherExpenses = 0;

                companyExpenses.forEach(exp => {
                    const amount = parseFloat(exp.amount) || 0;
                    // Use category field if available, otherwise use type
                    const category = (exp.category || exp.type || 'other').toLowerCase();

                    if (category.includes('fuel')) {
                        fuelExpenses += amount;
                    } else if (category.includes('insurance')) {
                        insuranceExpenses += amount;
                    } else if (category.includes('maintenance') || category.includes('repair')) {
                        maintenanceExpenses += amount;
                    } else if (category === 'lease_payment' || category === 'loan_payment' || category === 'truck_payment') {
                        // Truck payments - will be calculated separately to avoid double counting
                        truckPayments += amount;
                    } else if (category === 'rent' || category === 'software' || category === 'salary' || category === 'overhead' || category === 'fixed' || category === 'office') {
                        fixedExpenses += amount;
                    } else {
                        otherExpenses += amount;
                    }
                });

                // DEDUCT COMPANY-PAID EXPENSES FROM OWNER OPERATOR PAY
                // If company paid for fuel/insurance/etc for an Owner Operator, that amount 
                // is an expense for the company, but it should be deducted from the driver's pay
                // so that Net Profit = Commission.
                // Math: Revenue - (DriverGrossPay - Deductions) - Expenses = Commission
                //       Revenue - DriverGrossPay + Deductions - Expenses = Commission
                //       (Revenue - DriverGrossPay - Expenses) + Deductions = Commission
                // Since Expenses includes the Deductions amount, they cancel out if we don't deduct from pay.
                // Wait: Revenue (3200) - DriverPay (2816) - Expenses (300) = 84. Commission is 384.
                // We need Profit to be 384.
                // So DriverPay needs to be 2816 - 300 = 2516.
                // Then: 3200 - 2516 - 300 = 384. Correct.

                let deductionsFromOOPay = 0;
                companyExpenses.forEach(exp => {
                    if (exp.driverId) {
                        const driver = drivers.find(d => d.id === exp.driverId);
                        if (driver && driver.driverType === 'owner_operator') {
                            deductionsFromOOPay += parseFloat(exp.amount) || 0;
                        }
                    } else if (exp.truckId) {
                        // Also check by truck if driver not set (e.g. insurance)
                        const truck = DataManager.trucks.find(t => t.id === exp.truckId);
                        if (truck && truck.ownership === 'owner_operator') {
                            deductionsFromOOPay += parseFloat(exp.amount) || 0;
                        }
                    }
                });

                // Apply deductions
                ownerOperatorPay = Math.max(0, ownerOperatorPay - deductionsFromOOPay);

                // Calculate truck payments (leases + loan payments)
                // Note: For loan payments, ideally we'd calculate interest portion only,
                // but for simplicity, we'll count full payment as expense (principal is asset)
                // If truck payments aren't already in expenses (from recurring expenses),
                // calculate them from truck data
                const trucks = DataManager.trucks || [];
                const periodMonths = startDate ? Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24 * 30))) : 1;

                // Check if truck payments are already in expenses (from recurring expenses)
                const existingTruckPaymentExpenses = companyExpenses.filter(exp => {
                    const type = (exp.type || '').toLowerCase();
                    return type === 'lease_payment' || type === 'loan_payment';
                });

                const existingTruckPaymentTotal = existingTruckPaymentExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);

                // If we already have truck payment expenses from the forEach loop above, use those
                // Otherwise, calculate from truck monthly payments
                if (existingTruckPaymentTotal === 0) {
                    // Calculate from truck monthly payments if not already in expenses
                    trucks.forEach(truck => {
                        if ((truck.ownership === 'leased' || truck.ownership === 'financed') && truck.monthlyPayment) {
                            // Only count if truck is company-owned (not O/O)
                            if (truck.ownership !== 'owner_operator') {
                                truckPayments += truck.monthlyPayment * periodMonths;
                            }
                        }
                    });
                }
                // If existingTruckPaymentTotal > 0, truckPayments already set from forEach loop above

                const totalExpenses = fuelExpenses + insuranceExpenses + maintenanceExpenses + fixedExpenses + truckPayments + otherExpenses;

                // 6. Net Profit = Revenue - Driver Pay - Expenses
                // Note: Owner-as-driver pay is already included in driver pay,
                // so net profit is what owner gets as distribution (no double counting)
                const netProfit = totalRevenue - totalDriverPay - totalExpenses;

                // 7. Profit Margin = (Net Profit / Revenue) Ã— 100
                const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;

                // 8. Monthly Revenue (Group revenue loads by month - booked, in_transit, delivered)
                const monthlyRevenue = Array(12).fill(0);
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                revenueLoads.forEach(load => {
                    const date = new Date(load.deliveredAt || load.delivery?.date || load.pickedUpAt || load.createdAt);
                    const month = date.getMonth(); // 0-11
                    if (!isNaN(month)) {
                        monthlyRevenue[month] += (parseFloat(load.companyRevenue || load.rate?.total || load.rate || 0) || 0);
                    }
                });

                // 6. Load Status
                const statusCounts = {
                    'delivered': 0,
                    'in_transit': 0,
                    'available': 0,
                    'cancelled': 0
                };
                loads.forEach(l => {
                    const s = l.status.toLowerCase().replace(' ', '_');
                    if (statusCounts[s] !== undefined) statusCounts[s]++;
                    else if (s === 'completed') statusCounts['delivered']++;
                    else if (s === 'pending') statusCounts['available']++;
                });

                // 7. Driver Performance
                const driverStats = drivers.map(d => {
                    const driverLoads = completedLoads.filter(l => String(l.driverId) === String(d.id));
                    const miles = driverLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);
                    const revenue = driverLoads.reduce((sum, l) => sum + (parseFloat(l.companyRevenue || l.rate?.total || l.rate || 0) || 0), 0);
                    const loadCount = driverLoads.length;
                    // Simple performance score logic
                    const performance = loadCount > 0 ? Math.min(100, 80 + (loadCount * 2)) : 80;

                    return {
                        name: `${d.firstName || d.personalInfo?.firstName || ''} ${d.lastName || d.personalInfo?.lastName || ''}`,
                        miles,
                        revenue,
                        loads: loadCount,
                        performance
                    };
                }).sort((a, b) => b.revenue - a.revenue);

                // 8. Customer Analysis
                const customerStats = customers.map(c => {
                    const custLoads = completedLoads.filter(l => String(l.customerId) === String(c.id));
                    const revenue = custLoads.reduce((sum, l) => sum + (parseFloat(l.companyRevenue || l.rate?.total || l.rate || 0) || 0), 0);
                    const loadCount = custLoads.length;
                    const totalMiles = custLoads.reduce((sum, l) => sum + (parseFloat(l.mileage?.total || l.miles || 0) || 0), 0);
                    const avgRate = totalMiles > 0 ? (revenue / totalMiles).toFixed(2) : '0.00';

                    return {
                        name: c.company?.name || c.name || 'Unknown',
                        revenue,
                        loads: loadCount,
                        avgRate,
                        terms: c.financial?.paymentTerms || 'Net 30'
                    };
                }).sort((a, b) => b.revenue - a.revenue);

                // 9. Expense Breakdown (Group by actual expense types - exclude O/O-paid)
                const expenseByType = {};
                companyExpenses.forEach(exp => {
                    const type = exp.type || 'other';
                    const amount = parseFloat(exp.amount) || 0;
                    expenseByType[type] = (expenseByType[type] || 0) + amount;
                });

                // Map expense types to display labels
                const typeLabels = {
                    'fuel': 'Fuel',
                    'maintenance': 'Maintenance',
                    'insurance': 'Insurance',
                    'toll': 'Tolls',
                    'lumper': 'Lumper Fees',
                    'other': 'Other'
                };

                const expenseLabels = [];
                const expenseValues = [];
                Object.entries(expenseByType).forEach(([type, amount]) => {
                    expenseLabels.push(typeLabels[type] || type.charAt(0).toUpperCase() + type.slice(1));
                    expenseValues.push(amount);
                });

                // If no expenses, show placeholder
                const expenseChartData = {
                    labels: expenseLabels.length > 0 ? expenseLabels : ['No Expenses'],
                    values: expenseValues.length > 0 ? expenseValues : [0]
                };

                // Debug: Log expense breakdown before storing
                console.log('[Reports] Storing expense breakdown:', {
                    fuel: fuelExpenses,
                    insurance: insuranceExpenses,
                    maintenance: maintenanceExpenses,
                    fixed: fixedExpenses,
                    truckPayments: truckPayments,
                    other: otherExpenses,
                    total: totalExpenses
                });

                ReportManager.data = {
                    revenue: totalRevenue,
                    revenueBreakdown: {
                        companyDriver: companyDriverRevenue,
                        ownerOperator: ownerOperatorRevenue
                    },
                    miles: totalMiles,
                    loads: loadsCompleted,
                    driverPay: totalDriverPay,
                    driverPayBreakdown: {
                        companyDriver: companyDriverPay,
                        ownerOperator: ownerOperatorPay,
                        ownerAsDriver: ownerAsDriverPay
                    },
                    expenses: totalExpenses,
                    expenseBreakdown: {
                        fuel: fuelExpenses,
                        insurance: insuranceExpenses,
                        maintenance: maintenanceExpenses,
                        fixed: fixedExpenses,
                        truckPayments: truckPayments,
                        other: otherExpenses
                    },
                    netProfit: netProfit,
                    profitMargin,
                    revenueLoads: revenueLoads, // Store for revenue table calculations
                    completedLoads: completedLoads, // Store for driver/customer analysis
                    monthlyRevenue: {
                        labels: monthLabels,
                        values: monthlyRevenue
                    },
                    loadStatus: {
                        labels: ['Delivered', 'In Transit', 'Available', 'Cancelled'],
                        values: [
                            statusCounts['delivered'],
                            statusCounts['in_transit'],
                            statusCounts['available'],
                            statusCounts['cancelled']
                        ]
                    },
                    expenseChartData, // Keep for chart compatibility
                    drivers: driverStats,
                    customers: customerStats
                };
            },

            // Switch tabs
            switchTab: (tabName) => {
                ReportManager.currentTab = tabName;

                // Update tab styles
                document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                    tab.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700';
                });
                document.getElementById(tabName + 'Tab').className = 'py-4 px-1 border-b-2 border-blue-600 font-medium text-sm text-blue-600';

                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName + 'Content').classList.remove('hidden');

                // Load tab content
                ReportManager.loadTabContent(tabName);
            },

            // Load tab content
            loadTabContent: (tabName) => {
                switch (tabName) {
                    case 'overview':
                        ReportManager.loadOverview();
                        break;
                    case 'revenue':
                        ReportManager.loadRevenue();
                        break;
                    case 'expenses':
                        ReportManager.loadExpenses();
                        break;
                    case 'drivers':
                        ReportManager.loadDrivers();
                        break;
                    case 'customers':
                        ReportManager.loadCustomers();
                        break;
                }
            },

            // Load overview tab
            loadOverview: () => {
                // Update metrics
                document.getElementById('totalRevenue').textContent = Utils.formatCurrency(ReportManager.data.revenue);
                document.getElementById('totalMiles').textContent = ReportManager.data.miles.toLocaleString();
                document.getElementById('loadsCompleted').textContent = ReportManager.data.loads;
                document.getElementById('netProfit').textContent = Utils.formatCurrency(ReportManager.data.netProfit);
                document.getElementById('profitMargin').textContent = ReportManager.data.profitMargin + '%';

                // Update profit breakdown
                const breakdownRevenue = document.getElementById('breakdownRevenue');
                const breakdownRevenueCompany = document.getElementById('breakdownRevenueCompany');
                const breakdownRevenueOO = document.getElementById('breakdownRevenueOO');
                const breakdownExpenses = document.getElementById('breakdownExpenses');
                const breakdownExpenseFuel = document.getElementById('breakdownExpenseFuel');
                const breakdownExpenseInsurance = document.getElementById('breakdownExpenseInsurance');
                const breakdownExpenseMaintenance = document.getElementById('breakdownExpenseMaintenance');
                const breakdownExpenseTruckPayments = document.getElementById('breakdownExpenseTruckPayments');
                const breakdownExpenseFixed = document.getElementById('breakdownExpenseFixed');
                const breakdownExpenseOther = document.getElementById('breakdownExpenseOther');
                const breakdownDriverPay = document.getElementById('breakdownDriverPay');
                const breakdownDriverPayCompany = document.getElementById('breakdownDriverPayCompany');
                const breakdownDriverPayOO = document.getElementById('breakdownDriverPayOO');
                const breakdownDriverPayOwner = document.getElementById('breakdownDriverPayOwner');
                const breakdownNetProfit = document.getElementById('breakdownNetProfit');

                if (breakdownRevenue) breakdownRevenue.textContent = Utils.formatCurrency(ReportManager.data.revenue);
                if (breakdownRevenueCompany) breakdownRevenueCompany.textContent = Utils.formatCurrency(ReportManager.data.revenueBreakdown?.companyDriver || 0);
                if (breakdownRevenueOO) breakdownRevenueOO.textContent = Utils.formatCurrency(ReportManager.data.revenueBreakdown?.ownerOperator || 0);

                // Debug: Log what we're trying to display
                console.log('[Reports] Displaying expense breakdown:', {
                    total: ReportManager.data.expenses,
                    breakdown: ReportManager.data.expenseBreakdown
                });

                if (breakdownExpenses) breakdownExpenses.textContent = Utils.formatCurrency(ReportManager.data.expenses);
                if (breakdownExpenseFuel) {
                    const fuelValue = ReportManager.data.expenseBreakdown?.fuel || 0;
                    console.log('[Reports] Setting fuel expense:', fuelValue);
                    breakdownExpenseFuel.textContent = Utils.formatCurrency(fuelValue);
                }
                if (breakdownExpenseInsurance) {
                    const insuranceValue = ReportManager.data.expenseBreakdown?.insurance || 0;
                    console.log('[Reports] Setting insurance expense:', insuranceValue);
                    breakdownExpenseInsurance.textContent = Utils.formatCurrency(insuranceValue);
                }
                if (breakdownExpenseMaintenance) {
                    const maintenanceValue = ReportManager.data.expenseBreakdown?.maintenance || 0;
                    console.log('[Reports] Setting maintenance expense:', maintenanceValue);
                    breakdownExpenseMaintenance.textContent = Utils.formatCurrency(maintenanceValue);
                }
                if (breakdownExpenseTruckPayments) breakdownExpenseTruckPayments.textContent = Utils.formatCurrency(ReportManager.data.expenseBreakdown?.truckPayments || 0);
                if (breakdownExpenseFixed) {
                    const fixedValue = ReportManager.data.expenseBreakdown?.fixed || 0;
                    console.log('[Reports] Setting fixed expense:', fixedValue);
                    breakdownExpenseFixed.textContent = Utils.formatCurrency(fixedValue);
                }
                if (breakdownExpenseOther) {
                    const otherValue = ReportManager.data.expenseBreakdown?.other || 0;
                    console.log('[Reports] Setting other expense:', otherValue);
                    breakdownExpenseOther.textContent = Utils.formatCurrency(otherValue);
                }

                if (breakdownDriverPay) breakdownDriverPay.textContent = Utils.formatCurrency(ReportManager.data.driverPay);
                if (breakdownDriverPayCompany) breakdownDriverPayCompany.textContent = Utils.formatCurrency(ReportManager.data.driverPayBreakdown?.companyDriver || 0);
                if (breakdownDriverPayOO) breakdownDriverPayOO.textContent = Utils.formatCurrency(ReportManager.data.driverPayBreakdown?.ownerOperator || 0);
                if (breakdownDriverPayOwner) breakdownDriverPayOwner.textContent = Utils.formatCurrency(ReportManager.data.driverPayBreakdown?.ownerAsDriver || 0);

                if (breakdownNetProfit) {
                    breakdownNetProfit.textContent = Utils.formatCurrency(ReportManager.data.netProfit);
                    // Color code profit (green if positive, red if negative)
                    breakdownNetProfit.className = ReportManager.data.netProfit >= 0
                        ? 'font-bold text-xl text-green-600'
                        : 'font-bold text-xl text-red-600';
                }

                // Revenue trend chart
                const revenueTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: ReportManager.data.monthlyRevenue.values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Revenue',
                    line: { color: '#2563eb', width: 3, shape: 'spline' }, // Smooth line, darker blue
                    marker: { size: 8, color: '#1d4ed8', line: { color: '#ffffff', width: 2 } },
                    hovertemplate: '<b>%{x}</b><br>Revenue: $%{y:,.2f}<extra></extra>'
                };

                Plotly.newPlot('revenueChart', [revenueTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Month',
                        showgrid: false,
                        zeroline: false
                    },
                    yaxis: {
                        title: 'Revenue ($)',
                        gridcolor: '#f3f4f6',
                        zeroline: false,
                        tickprefix: '$'
                    },
                    margin: { t: 20, r: 20, b: 50, l: 60 },
                    hovermode: 'x',
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff'
                }, { responsive: true, displayModeBar: false });

                // Load status chart
                const loadStatusTrace = {
                    labels: ReportManager.data.loadStatus.labels,
                    values: ReportManager.data.loadStatus.values,
                    type: 'pie',
                    marker: {
                        colors: ['#10b981', '#3b82f6', '#9ca3af', '#ef4444'] // Emerald, Blue, Gray, Red
                    },
                    textinfo: 'label+percent',
                    textposition: 'inside',
                    hole: 0.4, // Donut chart style
                    hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
                };

                Plotly.newPlot('loadStatusChart', [loadStatusTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    margin: { t: 20, r: 20, b: 20, l: 20 },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1 }
                }, { responsive: true, displayModeBar: false });
            },

            // Load revenue tab
            loadRevenue: () => {
                // Monthly revenue chart
                const monthlyTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: ReportManager.data.monthlyRevenue.values,
                    type: 'bar',
                    name: 'Revenue',
                    marker: {
                        color: '#3b82f6',
                        line: { color: '#2563eb', width: 1.5 }
                    },
                    hovertemplate: '<b>%{x}</b><br>Revenue: $%{y:,.2f}<extra></extra>'
                };

                Plotly.newPlot('monthlyRevenueChart', [monthlyTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Month',
                        showgrid: false
                    },
                    yaxis: {
                        title: 'Revenue ($)',
                        gridcolor: '#f3f4f6',
                        tickprefix: '$'
                    },
                    margin: { t: 20, r: 20, b: 50, l: 60 },
                    hovermode: 'x',
                    bargap: 0.3
                }, { responsive: true, displayModeBar: false });

                // Customer revenue chart
                const customerTrace = {
                    x: ReportManager.data.customers.map(c => c.name),
                    y: ReportManager.data.customers.map(c => c.revenue),
                    type: 'bar',
                    name: 'Revenue',
                    marker: {
                        color: '#10b981',
                        line: { color: '#059669', width: 1.5 }
                    },
                    hovertemplate: '<b>%{x}</b><br>Revenue: $%{y:,.2f}<extra></extra>'
                };

                Plotly.newPlot('customerRevenueChart', [customerTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Customer',
                        tickangle: -45,
                        showgrid: false
                    },
                    yaxis: {
                        title: 'Revenue ($)',
                        gridcolor: '#f3f4f6',
                        tickprefix: '$'
                    },
                    margin: { t: 20, r: 20, b: 100, l: 60 }, // Increased bottom margin for labels
                    hovermode: 'x',
                    bargap: 0.3
                }, { responsive: true, displayModeBar: false });

                // Revenue table - calculate actual monthly data from revenue loads (booked, in_transit, delivered)
                const tbody = document.getElementById('revenueTableBody');
                tbody.innerHTML = '';

                const currentYear = new Date().getFullYear();
                const monthlyData = {};

                // Use revenueLoads (booked, in_transit, delivered) for revenue table
                const revenueLoads = ReportManager.data.revenueLoads || [];
                revenueLoads.forEach(load => {
                    const date = new Date(load.deliveredAt || load.delivery?.date || load.pickedUpAt || load.createdAt);
                    const month = date.getMonth();
                    const year = date.getFullYear();

                    if (year === currentYear && !isNaN(month)) {
                        if (!monthlyData[month]) {
                            monthlyData[month] = { revenue: 0, loads: 0, miles: 0 };
                        }
                        monthlyData[month].revenue += parseFloat(load.companyRevenue || load.rate?.total || load.rate || 0) || 0;
                        monthlyData[month].loads += 1;
                        monthlyData[month].miles += parseFloat(load.mileage?.total || load.miles || 0) || 0;
                    }
                });

                ReportManager.data.monthlyRevenue.labels.forEach((month, index) => {
                    const data = monthlyData[index] || { revenue: 0, loads: 0, miles: 0 };
                    if (data.revenue > 0 || data.loads > 0) {
                        const ratePerMile = data.miles > 0 ? (data.revenue / data.miles).toFixed(2) : '0.00';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${month} ${currentYear}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(data.revenue)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.loads}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.miles.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${ratePerMile}</td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            },

            // Load expenses tab
            loadExpenses: () => {
                // Expense breakdown chart
                const expenseTrace = {
                    labels: ReportManager.data.expenseChartData.labels,
                    values: ReportManager.data.expenseChartData.values,
                    type: 'pie',
                    marker: {
                        colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']
                    },
                    textinfo: 'label+percent',
                    textposition: 'inside',
                    hole: 0.4,
                    hovertemplate: '<b>%{label}</b><br>Amount: $%{value:,.2f}<br>Percentage: %{percent}<extra></extra>'
                };

                Plotly.newPlot('expenseBreakdownChart', [expenseTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    margin: { t: 20, r: 20, b: 20, l: 20 },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1 }
                }, { responsive: true, displayModeBar: false });

                // Expense trend chart (Calculate actual monthly expenses)
                const monthlyExpenses = Array(12).fill(0);
                // Get expenses from DataManager (filtered by period if needed)
                const allExpenses = DataManager.expenses || [];
                allExpenses.forEach(exp => {
                    const date = new Date(exp.date || exp.createdAt);
                    const month = date.getMonth();
                    if (!isNaN(month)) {
                        monthlyExpenses[month] += parseFloat(exp.amount) || 0;
                    }
                });

                const trendTrace = {
                    x: ReportManager.data.monthlyRevenue.labels,
                    y: monthlyExpenses,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Expenses',
                    line: { color: '#ef4444', width: 3, shape: 'spline' },
                    marker: { size: 8, color: '#dc2626', line: { color: '#ffffff', width: 2 } },
                    hovertemplate: '<b>%{x}</b><br>Expenses: $%{y:,.2f}<extra></extra>'
                };

                Plotly.newPlot('expenseTrendChart', [trendTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Month',
                        showgrid: false
                    },
                    yaxis: {
                        title: 'Expenses ($)',
                        gridcolor: '#f3f4f6',
                        tickprefix: '$'
                    },
                    margin: { t: 20, r: 20, b: 50, l: 60 },
                    hovermode: 'x'
                }, { responsive: true, displayModeBar: false });
            },

            // Load drivers tab
            loadDrivers: () => {
                // Driver performance chart
                const performanceTrace = {
                    x: ReportManager.data.drivers.map(d => d.name),
                    y: ReportManager.data.drivers.map(d => d.performance),
                    type: 'bar',
                    name: 'Performance Score',
                    marker: {
                        color: '#3b82f6',
                        line: { color: '#2563eb', width: 1.5 }
                    },
                    hovertemplate: '<b>%{x}</b><br>Score: %{y}%<extra></extra>'
                };

                Plotly.newPlot('driverPerformanceChart', [performanceTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Driver',
                        tickangle: -45,
                        showgrid: false
                    },
                    yaxis: {
                        title: 'Performance Score',
                        range: [0, 100],
                        gridcolor: '#f3f4f6'
                    },
                    margin: { t: 20, r: 20, b: 100, l: 60 },
                    hovermode: 'x',
                    bargap: 0.3
                }, { responsive: true, displayModeBar: false });

                // Driver table
                const tbody = document.getElementById('driverTableBody');
                tbody.innerHTML = '';

                ReportManager.data.drivers.forEach(driver => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${driver.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.miles.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(driver.revenue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.loads}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${driver.performance}%"></div>
                                </div>
                                <span class="text-sm text-gray-900">${driver.performance}%</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Load customers tab
            loadCustomers: () => {
                // Customer analysis chart
                const analysisTrace = {
                    x: ReportManager.data.customers.map(c => c.name),
                    y: ReportManager.data.customers.map(c => c.revenue),
                    type: 'bar',
                    name: 'Revenue',
                    marker: {
                        color: '#10b981',
                        line: { color: '#059669', width: 1.5 }
                    },
                    hovertemplate: '<b>%{x}</b><br>Revenue: $%{y:,.2f}<extra></extra>'
                };

                Plotly.newPlot('customerAnalysisChart', [analysisTrace], {
                    title: '',
                    font: { family: 'Inter, sans-serif' },
                    xaxis: {
                        title: 'Customer',
                        tickangle: -45,
                        showgrid: false
                    },
                    yaxis: {
                        title: 'Revenue ($)',
                        gridcolor: '#f3f4f6',
                        tickprefix: '$'
                    },
                    margin: { t: 20, r: 20, b: 100, l: 60 },
                    hovermode: 'x',
                    bargap: 0.3
                }, { responsive: true, displayModeBar: false });

                // Customer table
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = '';

                ReportManager.data.customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(customer.revenue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.loads}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${customer.avgRate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.terms}</td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Print report
            printReport: () => {
                window.print();
            },

            // Export report
            exportReport: () => {
                // Recalculate data to ensure we have the latest values
                ReportManager.calculateRealData();

                const currentTab = ReportManager.currentTab;
                const period = document.getElementById('reportPeriod').value;
                const data = ReportManager.data;

                // Debug: Log the data being exported
                console.log('Export Debug - Current Tab:', currentTab);
                console.log('Export Debug - Period:', period);
                console.log('Export Debug - Data Object:', data);
                console.log('Export Debug - Total Revenue:', data.totalRevenue);
                console.log('Export Debug - DataManager Loads:', DataManager.loads.length);
                console.log('Export Debug - DataManager Expenses:', DataManager.expenses.length);

                let csvContent = '';
                let filename = '';
                const date = new Date().toISOString().split('T')[0];

                // Helper function to format currency for CSV
                const formatCSV = (value) => {
                    if (value === null || value === undefined || value === '' || isNaN(value)) {
                        return '0.00';
                    }
                    if (typeof value === 'number') {
                        return value.toFixed(2);
                    }
                    const num = parseFloat(value);
                    return isNaN(num) ? '0.00' : num.toFixed(2);
                };

                // Helper function to escape CSV values
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                switch (currentTab) {
                    case 'overview':
                        filename = `overview-report-${date}.csv`;
                        csvContent = 'Metric,Amount\n';
                        csvContent += `Total Revenue,$${formatCSV(data.totalRevenue)}\n`;
                        csvContent += `Company Driver Revenue,$${formatCSV(data.companyDriverRevenue)}\n`;
                        csvContent += `Owner Operator Revenue,$${formatCSV(data.ownerOperatorRevenue)}\n`;
                        csvContent += `Total Miles,${formatCSV(data.totalMiles)}\n`;
                        csvContent += `Loads Completed,${data.loadsCompleted}\n`;
                        csvContent += `Total Driver Pay,$${formatCSV(data.totalDriverPay)}\n`;
                        csvContent += `Company Driver Pay,$${formatCSV(data.companyDriverPay)}\n`;
                        csvContent += `Owner Operator Pay,$${formatCSV(data.ownerOperatorPay)}\n`;
                        csvContent += `Owner as Driver Pay,$${formatCSV(data.ownerAsDriverPay)}\n`;
                        csvContent += `Total Expenses,$${formatCSV(data.totalExpenses)}\n`;
                        csvContent += `Fuel Expenses,$${formatCSV(data.fuelExpenses)}\n`;
                        csvContent += `Insurance Expenses,$${formatCSV(data.insuranceExpenses)}\n`;
                        csvContent += `Maintenance Expenses,$${formatCSV(data.maintenanceExpenses)}\n`;
                        csvContent += `Fixed Expenses,$${formatCSV(data.fixedExpenses)}\n`;
                        csvContent += `Truck Payments,$${formatCSV(data.truckPayments)}\n`;
                        csvContent += `Other Expenses,$${formatCSV(data.otherExpenses)}\n`;
                        csvContent += `Net Profit,$${formatCSV(data.netProfit)}\n`;
                        csvContent += `Profit Margin,${formatCSV(data.profitMargin)}%\n`;
                        break;

                    case 'revenue':
                        filename = `revenue-report-${date}.csv`;
                        csvContent = 'Month,Revenue\n';
                        if (data.monthlyRevenue && data.monthLabels) {
                            data.monthLabels.forEach((month, idx) => {
                                csvContent += `${month},$${formatCSV(data.monthlyRevenue[idx])}\n`;
                            });
                        }
                        csvContent += '\n';
                        csvContent += 'Customer,Revenue\n';
                        if (data.customerRevenue) {
                            Object.entries(data.customerRevenue).forEach(([customer, revenue]) => {
                                csvContent += `${escapeCSV(customer)},$${formatCSV(revenue)}\n`;
                            });
                        }
                        break;

                    case 'expenses':
                        filename = `expenses-report-${date}.csv`;
                        csvContent = 'Category,Amount\n';
                        csvContent += `Fuel,$${formatCSV(data.fuelExpenses)}\n`;
                        csvContent += `Insurance,$${formatCSV(data.insuranceExpenses)}\n`;
                        csvContent += `Maintenance,$${formatCSV(data.maintenanceExpenses)}\n`;
                        csvContent += `Fixed Expenses,$${formatCSV(data.fixedExpenses)}\n`;
                        csvContent += `Truck Payments,$${formatCSV(data.truckPayments)}\n`;
                        csvContent += `Other Expenses,$${formatCSV(data.otherExpenses)}\n`;
                        csvContent += `Total,$${formatCSV(data.totalExpenses)}\n`;
                        break;

                    case 'drivers':
                        filename = `drivers-report-${date}.csv`;
                        csvContent = 'Driver Type,Pay Amount\n';
                        csvContent += `Company Drivers,$${formatCSV(data.companyDriverPay)}\n`;
                        csvContent += `Owner Operators,$${formatCSV(data.ownerOperatorPay)}\n`;
                        csvContent += `Owner as Driver,$${formatCSV(data.ownerAsDriverPay)}\n`;
                        csvContent += `Total,$${formatCSV(data.totalDriverPay)}\n`;
                        break;

                    default:
                        Utils.showNotification('Please select a tab to export', 'warning');
                        return;
                }

                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                Utils.showNotification(`Report exported: ${filename}`, 'success');
            },

            // Setup event listeners
            setupEventListeners: () => {
                document.getElementById('reportPeriod').addEventListener('change', (e) => {
                    // Recalculate data based on selected period
                    ReportManager.calculateRealData();
                    ReportManager.loadTabContent(ReportManager.currentTab);
                    Utils.showNotification(`Reports updated for ${e.target.value}`, 'info');
                });
            }
        };

        // Auto-refresh reports when data changes (connected to DataManager listeners)
        window.renderLoads = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to loads change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderExpenses = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to expenses change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderSettlements = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to settlements change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.renderDrivers = () => {
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to drivers change');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        window.updateDashboard = () => {
            // Dashboard updates can also trigger report refresh if needed
            if (ReportManager.currentTab) {
                console.log('[Reports] Refreshing reports due to dashboard update');
                ReportManager.calculateRealData();
                ReportManager.loadTabContent(ReportManager.currentTab);
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for DataManager to load all data from Firebase first
            await DataManager.init();
            // Wait a bit for all Firebase listeners to populate data
            await new Promise(resolve => setTimeout(resolve, 1000));
            // Then initialize reports with the loaded data
            ReportManager.init();
            // Force refresh the overview tab to ensure data is displayed
            if (ReportManager.currentTab === 'overview') {
                ReportManager.loadOverview();
            }
        });
    </script>
</body>

</html>