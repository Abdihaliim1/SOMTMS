<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Settlements - ATS FREIGHT LLC (Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1f2937;
        }

        .text-navy {
            color: #1f2937;
        }

        .gradient-bg {
            background-color: #1f2937;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-paid {
            background-color: #10b981;
        }

        .status-pending {
            background-color: #f59e0b;
        }

        .status-processed {
            background-color: #3b82f6;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC" class="h-12 w-12 object-contain"
                        onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');">
                    <div
                        class="company-logo hidden w-12 h-12 bg-white rounded-lg items-center justify-center font-bold text-gray-800">
                        ATS</div>
                    <div>
                        <h1 class="text-xl font-bold">ATS FREIGHT LLC</h1>
                        <p class="text-sm opacity-90">Transportation Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="loads.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-truck mr-2"></i>Loads
                    </a>
                    <a href="drivers.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-users mr-2"></i>Drivers
                    </a>
                    <span class="nav-item active px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-calculator mr-2"></i>Settlements
                    </span>
                    <span class="text-sm">Welcome, Liban Ali</span>
                    <button class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Driver Settlements</h2>
                <p class="text-gray-600 mt-2">Manage driver payments and settlements</p>
            </div>
            <div class="flex items-center space-x-4">

                <button onclick="openGenerateSettlementModal()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Generate Settlement
                </button>
            </div>
        </div>

        <!-- Settlement Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">This Week</dt>
                            <dd id="thisWeekTotal" class="text-2xl font-semibold text-gray-900">$0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Settlements</dt>
                            <dd id="totalSettlements" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                            <dd id="pendingSettlements" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calculator text-purple-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg Settlement</dt>
                            <dd id="avgSettlement" class="text-2xl font-semibold text-gray-900">$0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlement Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Weekly Settlement Trends</h3>
                <div id="settlementChart" class="h-64"></div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Status Distribution</h3>
                <div id="paymentStatusChart" class="h-64"></div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="driverFilter" class="block text-sm font-medium text-gray-700 mb-2">Driver</label>
                    <select id="driverFilter" aria-label="Filter by Driver"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Drivers</option>
                    </select>
                </div>
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilter" aria-label="Filter by Status"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processed">Processed</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div>
                    <label for="weekFilter" class="block text-sm font-medium text-gray-700 mb-2">Week</label>
                    <input type="week" id="weekFilter"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-end">
                    <button
                        class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Settlements Table -->
        <div class="bg-white rounded-lg card-shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Driver Settlements</h3>
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button onclick="printAllSettlements()" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-print mr-2"></i>Print All
                        </button>
                        <button onclick="emailAllSettlements()" class="text-blue-600 hover:text-blue-800 ml-2">
                            <i class="fas fa-envelope mr-2"></i>Email All
                        </button>
                        <button onclick="refreshSettlements()" class="text-green-600 hover:text-green-800 ml-2">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Settlement #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Period</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Miles</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Gross Pay</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Deductions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Net Pay</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="settlementsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Settlement Modal -->
    <div id="createSettlementModal" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Generate Driver Settlement</h3>
                    <button onclick="closeCreateModal()" class="text-white hover:text-gray-200"
                        aria-label="Close Modal">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="settlementForm" class="space-y-6">
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="driverSelect" class="block text-sm font-medium text-gray-700">Select Driver</label>
                                <button type="button" onclick="refreshDriversList()" 
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">
                                    <i class="fas fa-refresh mr-1"></i>Refresh
                                </button>
                            </div>
                            <select id="driverSelect" aria-label="Select Driver"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select a driver...</option>
                            </select>
                        </div>
                    </div>

                    <div id="settlementLoadsSection" class="hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Available Loads</h4>
                        <div class="overflow-x-auto border rounded-lg mb-6">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                            Select</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Load #</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                            Pay Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="driverLoadsBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Deductions Section -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h5 class="font-medium text-gray-700 mb-3">Deductions</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Fuel</label>
                                    <input type="number" id="fuelDeduction" value="0" min="0" step="0.01"
                                        class="w-full border rounded px-3 py-2" onchange="calculateSettlementTotals()">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Other</label>
                                    <input type="number" id="otherDeduction" value="0" min="0" step="0.01"
                                        class="w-full border rounded px-3 py-2" onchange="calculateSettlementTotals()">
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <div class="border-t border-gray-200 pt-4 space-y-2">
                                <div class="flex justify-between text-gray-600">
                                    <span>Gross Pay:</span>
                                    <span id="grossPay" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500">
                                    <span>Total Deductions:</span>
                                    <span id="totalDeductions" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                    <span class="text-xl font-bold text-gray-900">Net Pay:</span>
                                    <span id="netPay" class="text-2xl font-extrabold text-green-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="noLoadsMessage" class="hidden text-center py-8">
                        <div class="bg-yellow-50 text-yellow-800 p-4 rounded-lg inline-block">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No unpaid delivered loads found for this driver.
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="closeCreateModal()"
                            class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors">
                            Cancel
                        </button>
                        <button type="button" id="generateSettlementBtn"
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Generate Settlement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="data-stability.js"></script>
    <script src="main.js"></script>
    <script src="expense-ledger-utils.js"></script>
    <script src="populate-mock-data.js"></script>
    <script>
        // FINAL WORKING VERSION — DRIVERS ALWAYS SHOW
        window.openGenerateSettlementModal = async function() {
            const modal = document.getElementById('createSettlementModal');
            if (!modal) return console.error('Modal not found');

            modal.classList.add('show');

            // Show loading state
            const select = document.getElementById('driverSelect');
            select.innerHTML = '<option>Loading drivers...</option>';

            // Reset everything
            document.getElementById('settlementLoadsSection').classList.add('hidden');
            document.getElementById('noLoadsMessage').classList.add('hidden');
            document.getElementById('driverLoadsBody').innerHTML = '';
            document.getElementById('grossPay').textContent = '$0.00';
            document.getElementById('totalDeductions').textContent = '$0.00';
            document.getElementById('netPay').textContent = '$0.00';
            document.getElementById('fuelDeduction').value = '0';
            document.getElementById('otherDeduction').value = '0';
            document.getElementById('generateSettlementBtn').disabled = true;
            
            // Clean up any previous expense banners
            const banners = document.querySelectorAll('.bg-red-50.border.border-red-200');
            banners.forEach(banner => banner.remove());
            window.autoPopulatedExpenses = [];

            // WAIT FOR DRIVERS TO LOAD — THIS IS THE FIX
            while (!DataManager?.drivers || DataManager.drivers.length === 0) {
                await new Promise(r => setTimeout(r, 100));
            }

            // NOW DRIVERS ARE READY
            select.innerHTML = '<option value="">Select a driver...</option>';
            DataManager.drivers.forEach(d => {
                const opt = new Option(`${d.firstName} ${d.lastName}`, d.id);
                select.add(opt);
            });
            console.log('Drivers loaded:', DataManager.drivers.length);
        };

        window.closeCreateModal = function() {
            document.getElementById('createSettlementModal').classList.remove('show');
            
            // Clean up any auto-populated expense banners
            const banners = document.querySelectorAll('.bg-red-50.border.border-red-200');
            banners.forEach(banner => banner.remove());
            
            // Clear auto-populated expenses
            window.autoPopulatedExpenses = [];
        };

        // Function to setup event listeners (called after DOM is ready)
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            // Event listener for driver selection
            const driverSelect = document.getElementById('driverSelect');
            if (!driverSelect) {
                console.error('driverSelect element not found');
                return;
            }
            console.log('driverSelect element found, adding change listener');
            
            driverSelect.addEventListener('change', async function() {
                console.log('Driver selection changed to:', this.value);
                const driverId = this.value;
                if (!driverId) {
                    console.log('No driver selected, hiding sections');
                    document.getElementById('settlementLoadsSection').classList.add('hidden');
                    document.getElementById('noLoadsMessage').classList.add('hidden');
                    return;
                }

            // Load unpaid delivered loads for this driver
            const driver = DataManager.drivers.find(d => d.id === driverId);
            if (!driver) return;

            // Get delivered loads without settlementId
            const unpaidLoads = DataManager.loads.filter(load => 
                load.driverId === driverId && 
                (load.status === 'delivered' || load.status === 'Delivered') &&
                !load.settlementId
            );

            const loadsBody = document.getElementById('driverLoadsBody');
            loadsBody.innerHTML = '';

            if (unpaidLoads.length === 0) {
                document.getElementById('settlementLoadsSection').classList.add('hidden');
                document.getElementById('noLoadsMessage').classList.remove('hidden');
                document.getElementById('generateSettlementBtn').disabled = true;
                return;
            }

            document.getElementById('settlementLoadsSection').classList.remove('hidden');
            document.getElementById('noLoadsMessage').classList.add('hidden');

            // Calculate driver pay percentage
            const payPercentage = Utils.validatePayPercentage(driver.payPercentage, driver.driverType);

            unpaidLoads.forEach(load => {
                const rate = parseFloat(load.rate?.total || load.rate || 0);
                const driverPay = rate * payPercentage;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">
                        <input type="checkbox" class="load-checkbox" data-load-id="${load.id}" data-pay="${driverPay}" checked>
                    </td>
                    <td class="px-4 py-2 text-sm">${load.loadNumber || load.id}</td>
                    <td class="px-4 py-2 text-sm">${load.deliveredAt ? new Date(load.deliveredAt).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-4 py-2 text-sm text-right">${Utils.formatCurrency(driverPay)}</td>
                `;
                loadsBody.appendChild(row);
            });

            // AUTO-POPULATE O/O EXPENSES — FINAL UPGRADE
            if (driver.driverType === 'owner_operator') {
                // Get all company-paid expenses for this O/O that aren't settled yet
                const unsettledExpenses = DataManager.expenses.filter(expense => 
                    expense.driverId === driverId && 
                    expense.paidBy === 'company' &&
                    !expense.settlementId
                );

                console.log(`[Settlement] Found ${unsettledExpenses.length} unsettled O/O expenses for ${driver.firstName} ${driver.lastName}`);

                if (unsettledExpenses.length > 0) {
                    // Auto-populate deduction fields based on expense categories
                    let totalFuel = 0;
                    let totalOther = 0;

                    unsettledExpenses.forEach(expense => {
                        const amount = parseFloat(expense.amount) || 0;
                        const category = (expense.category || expense.type || '').toLowerCase();
                        
                        if (category.includes('fuel')) {
                            totalFuel += amount;
                        } else {
                            totalOther += amount;
                        }
                    });

                    // Set the deduction amounts
                    document.getElementById('fuelDeduction').value = totalFuel.toFixed(2);
                    document.getElementById('otherDeduction').value = totalOther.toFixed(2);

                    // Show banner above deductions section
                    const deductionsSection = document.querySelector('.bg-gray-50.p-4.rounded-lg.mb-4');
                    if (deductionsSection) {
                        const banner = document.createElement('div');
                        banner.className = 'bg-red-50 border border-red-200 rounded-lg p-3 mb-4';
                        banner.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-red-800">Company Paid Expenses Found</p>
                                    <p class="text-xs text-red-600">These expenses will be deducted from net pay (${unsettledExpenses.length} expenses totaling ${Utils.formatCurrency(totalFuel + totalOther)})</p>
                                </div>
                            </div>
                        `;
                        deductionsSection.parentNode.insertBefore(banner, deductionsSection);
                    }

                    // Store expense IDs for settlement creation
                    window.autoPopulatedExpenses = unsettledExpenses.map(e => e.id);
                    
                    console.log(`[Settlement] Auto-populated: Fuel $${totalFuel}, Other $${totalOther}`);
                } else {
                    window.autoPopulatedExpenses = [];
                }
            } else {
                // Clear any auto-populated expenses for non-O/O drivers
                window.autoPopulatedExpenses = [];
            }

            // Add checkbox listeners
            document.querySelectorAll('.load-checkbox').forEach(cb => {
                cb.addEventListener('change', calculateSettlementTotals);
            });

            calculateSettlementTotals();
            document.getElementById('generateSettlementBtn').disabled = false;
            });

            // Generate Settlement button handler
            const generateBtn = document.getElementById('generateSettlementBtn');
            if (!generateBtn) {
                console.error('generateSettlementBtn element not found');
                return;
            }
            
            generateBtn.addEventListener('click', async function() {
                const driverId = document.getElementById('driverSelect').value;
                if (!driverId) {
                    Utils.showNotification('Please select a driver', 'warning');
                    return;
                }

                const checkedLoads = document.querySelectorAll('.load-checkbox:checked');
                if (checkedLoads.length === 0) {
                    Utils.showNotification('Please select at least one load', 'warning');
                    return;
                }

                const loadIds = Array.from(checkedLoads).map(cb => cb.dataset.loadId);
                const grossPay = parseFloat(document.getElementById('grossPay').textContent.replace(/[$,]/g, '')) || 0;
                const totalDeductions = parseFloat(document.getElementById('totalDeductions').textContent.replace(/[$,]/g, '')) || 0;
                const netPay = parseFloat(document.getElementById('netPay').textContent.replace(/[$,]/g, '')) || 0;

                const driver = DataManager.drivers.find(d => d.id === driverId);

                // Include auto-populated expenses for O/O
                const expenseIds = window.autoPopulatedExpenses || [];

                const settlementData = {
                    settlementNumber: 'ST-' + new Date().getFullYear() + '-' + Date.now().toString(36).toUpperCase(),
                    driverId: driverId,
                    driverName: `${driver.firstName} ${driver.lastName}`,
                    loadIds: loadIds,
                    expenseIds: expenseIds, // Include auto-populated expenses
                    grossPay: grossPay,
                    totalDeductions: totalDeductions,
                    netPay: netPay,
                    fuelDeduction: parseFloat(document.getElementById('fuelDeduction').value) || 0,
                    otherDeduction: parseFloat(document.getElementById('otherDeduction').value) || 0,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                try {
                    const id = await DataManager.addSettlement(settlementData);
                    
                    // Mark loads as settled
                    for (const loadId of loadIds) {
                        await DataManager.updateLoad(loadId, { settlementId: id });
                    }

                    // Mark auto-populated expenses as settled
                    for (const expenseId of expenseIds) {
                        await DataManager.updateExpense(expenseId, { settlementId: id });
                    }

                    Utils.showNotification(`Settlement created successfully! ${expenseIds.length > 0 ? `(${expenseIds.length} expenses included)` : ''}`, 'success');
                    closeCreateModal();
                    renderSettlementsTable();
                } catch (error) {
                    console.error('Error creating settlement:', error);
                    Utils.showNotification('Failed to create settlement', 'error');
                }
            });
        }

        window.refreshDriversList = async function() {
            const select = document.getElementById('driverSelect');
            select.innerHTML = '<option value="">Refreshing drivers...</option>';
            
            console.log('Manual refresh requested');
            console.log('DataManager status:', {
                exists: !!DataManager,
                driversExists: !!DataManager?.drivers,
                driversCount: DataManager?.drivers?.length || 0
            });
            
            // Force reinitialize if needed
            if (!DataManager || !DataManager.drivers || DataManager.drivers.length === 0) {
                try {
                    console.log('Reinitializing DataManager...');
                    await DataManager.init();
                } catch (error) {
                    console.error('Error reinitializing:', error);
                }
            }
            
            // Populate drivers
            if (DataManager?.drivers && DataManager.drivers.length > 0) {
                select.innerHTML = '<option value="">Select a driver...</option>';
                DataManager.drivers.forEach(d => {
                    const opt = new Option(`${d.firstName} ${d.lastName}`, d.id);
                    select.add(opt);
                });
                console.log('Drivers refreshed successfully:', DataManager.drivers.length);
            } else {
                select.innerHTML = '<option value="">No drivers found - check Firebase connection</option>';
                console.error('Still no drivers after refresh');
            }
        };

        function calculateSettlementTotals() {
            const checkboxes = document.querySelectorAll('.load-checkbox:checked');
            let grossPay = 0;

            checkboxes.forEach(cb => {
                grossPay += parseFloat(cb.dataset.pay) || 0;
            });

            // Get deductions (fuel, other, etc.)
            const fuelDeduction = parseFloat(document.getElementById('fuelDeduction')?.value) || 0;
            const otherDeduction = parseFloat(document.getElementById('otherDeduction')?.value) || 0;
            const totalDeductions = fuelDeduction + otherDeduction;

            const netPay = Math.max(0, grossPay - totalDeductions);

            document.getElementById('grossPay').textContent = Utils.formatCurrency(grossPay);
            document.getElementById('totalDeductions').textContent = Utils.formatCurrency(totalDeductions);
            document.getElementById('netPay').textContent = Utils.formatCurrency(netPay);
        }

        window.calculateSettlementTotals = calculateSettlementTotals;
        
        // Expose renderSettlementsTable globally for Firebase listener
        window.renderSettlements = function() {
            renderSettlementsTable();
            updateStats();
            updateSettlementCharts();
        };

        // Render settlements table with actual data
        function renderSettlementsTable() {
            console.log('renderSettlementsTable called');
            const tbody = document.getElementById('settlementsTableBody');
            if (!tbody) {
                console.error('settlementsTableBody not found');
                return;
            }
            
            tbody.innerHTML = '';
            const settlements = DataManager.settlements || [];
            console.log('Rendering settlements table with', settlements.length, 'settlements');
            
            if (settlements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-file-invoice-dollar text-4xl mb-4 text-gray-300"></i>
                            <p>No settlements found. Click "Generate Settlement" to create one.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            settlements.forEach(settlement => {
                const statusClass = settlement.status === 'paid' 
                    ? 'bg-green-100 text-green-800' 
                    : settlement.status === 'processed' 
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-yellow-100 text-yellow-800';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${settlement.settlementNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${settlement.driverName || 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${settlement.period?.display || formatDate(settlement.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${settlement.totalMiles || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Utils.formatCurrency(settlement.grossPay || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">-${Utils.formatCurrency(settlement.totalDeductions || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${Utils.formatCurrency(settlement.netPay || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${(settlement.status || 'pending').charAt(0).toUpperCase() + (settlement.status || 'pending').slice(1)}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        <button onclick="viewSettlement('${settlement.id}')" class="text-blue-600 hover:text-blue-800" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="printSettlement('${settlement.id}')" class="text-gray-600 hover:text-gray-800" title="Print PDF">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="emailSettlement('${settlement.id}')" class="text-blue-600 hover:text-blue-800 ml-2" title="Email Settlement">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button onclick="deleteSettlement('${settlement.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update stats after rendering
            updateStats();
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Update settlement statistics
        function updateStats() {
            const settlements = DataManager.settlements || [];
            
            // Total settlements
            document.getElementById('totalSettlements').textContent = settlements.length;
            
            // Pending settlements
            const pending = settlements.filter(s => s.status === 'pending').length;
            document.getElementById('pendingSettlements').textContent = pending;
            
            // This week's total
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const thisWeekSettlements = settlements.filter(s => {
                const created = new Date(s.createdAt);
                return created >= weekStart;
            });
            const thisWeekTotal = thisWeekSettlements.reduce((sum, s) => sum + (s.netPay || 0), 0);
            document.getElementById('thisWeekTotal').textContent = Utils.formatCurrency(thisWeekTotal);
            
            // Average settlement
            const avgSettlement = settlements.length > 0 
                ? settlements.reduce((sum, s) => sum + (s.netPay || 0), 0) / settlements.length 
                : 0;
            document.getElementById('avgSettlement').textContent = Utils.formatCurrency(avgSettlement);
        }

        // View settlement details (placeholder)
        window.viewSettlement = function(settlementId) {
            const settlement = DataManager.settlements.find(s => s.id === settlementId);
            if (!settlement) {
                Utils.showNotification('Settlement not found', 'error');
                return;
            }
            alert(`Settlement: ${settlement.settlementNumber}\nDriver: ${settlement.driverName}\nGross Pay: ${Utils.formatCurrency(settlement.grossPay)}\nDeductions: ${Utils.formatCurrency(settlement.totalDeductions)}\nNet Pay: ${Utils.formatCurrency(settlement.netPay)}\nStatus: ${settlement.status}`);
        };

        // Print settlement - Generate PDF
        window.printSettlement = function(settlementId) {
            const settlement = DataManager.settlements.find(s => s.id === settlementId);
            if (!settlement) {
                Utils.showNotification('Settlement not found', 'error');
                return;
            }

            try {
                // Validate settlement data before generating PDF
                if (!settlement.id && !settlement.settlementNumber) {
                    throw new Error('Settlement missing identification');
                }
                
                generateSettlementPDF(settlement);
                Utils.showNotification('Settlement PDF generated successfully', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                Utils.showNotification('Error generating PDF: ' + errorMessage, 'error');
            }
        };

        // Safe date formatting helper
        function safeFormatDate(dateValue, fallback = 'N/A') {
            if (!dateValue) return fallback;
            
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date value:', dateValue);
                    return fallback;
                }
                return Utils.formatDate(date);
            } catch (error) {
                console.warn('Error formatting date:', dateValue, error);
                return fallback;
            }
        }

        // Generate Professional Settlement PDF
        function generateSettlementPDF(settlement) {
            console.log('Generating professional PDF for settlement:', settlement);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get driver info
            const driver = DataManager.drivers.find(d => d.id === settlement.driverId);
            const driverName = driver ? `${driver.firstName} ${driver.lastName}` : 'Unknown Driver';
            
            // Colors
            const primaryColor = [31, 41, 55]; // Navy blue
            const accentColor = [59, 130, 246]; // Blue
            const successColor = [16, 185, 129]; // Green
            const grayColor = [107, 114, 128]; // Gray
            
            // === HEADER SECTION ===
            // Company logo background
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(0, 0, 210, 45, 'F');
            
            // Company name
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('ATS FREIGHT LLC', 20, 25);
            
            // Company details
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('3191 MORSE RD STE 15, COLUMBUS, OH 43231', 20, 32);
            doc.text('Phone: (614) 254-0380 | DOT: 3169186', 20, 38);
            
            // Settlement title with background
            doc.setFillColor(accentColor[0], accentColor[1], accentColor[2]);
            doc.rect(0, 45, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('DRIVER SETTLEMENT', 20, 58);
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // === SETTLEMENT INFO SECTION ===
            let yPos = 75;
            
            // Info box background
            doc.setFillColor(248, 250, 252);
            doc.rect(15, yPos, 180, 35, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.rect(15, yPos, 180, 35, 'S');
            
            // Settlement details
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            yPos += 10;
            doc.text('Settlement Information:', 20, yPos);
            
            doc.setFont(undefined, 'normal');
            yPos += 8;
            doc.text(`Settlement #: ${settlement.settlementNumber || settlement.id}`, 25, yPos);
            doc.text(`Driver: ${driverName}`, 110, yPos);
            
            yPos += 6;
            const startDate = safeFormatDate(settlement.startDate);
            const endDate = safeFormatDate(settlement.endDate);
            const generatedDate = safeFormatDate(new Date());
            
            doc.text(`Period: ${startDate} - ${endDate}`, 25, yPos);
            yPos += 6;
            doc.text(`Generated: ${generatedDate}`, 25, yPos);
            
            yPos += 20;
            
            // === LOADS SECTION ===
            if (settlement.loadIds && settlement.loadIds.length > 0) {
                // Section header
                doc.setFillColor(successColor[0], successColor[1], successColor[2]);
                doc.rect(15, yPos, 180, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('LOADS COMPLETED', 20, yPos + 8);
                
                yPos += 18;
                doc.setTextColor(0, 0, 0);
                
                // Table headers
                doc.setFillColor(243, 244, 246);
                doc.rect(15, yPos, 180, 10, 'F');
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Load #', 20, yPos + 6);
                doc.text('Route', 60, yPos + 6);
                doc.text('Amount', 160, yPos + 6);
                
                yPos += 12;
                doc.setFont(undefined, 'normal');
                
                // Load details
                settlement.loadIds.forEach((loadId, index) => {
                    const load = DataManager.loads.find(l => l.id === loadId);
                    if (load) {
                        // Alternating row colors
                        if (index % 2 === 0) {
                            doc.setFillColor(249, 250, 251);
                            doc.rect(15, yPos - 3, 180, 8, 'F');
                        }
                        
                        doc.text(load.loadNumber || 'N/A', 20, yPos);
                        doc.text(`${load.pickup?.city || 'N/A'} → ${load.delivery?.city || 'N/A'}`, 60, yPos);
                        doc.text(Utils.formatCurrency(load.rate?.total || 0), 160, yPos);
                        yPos += 8;
                    }
                });
                
                yPos += 10;
            }
            
            // === FINANCIAL SUMMARY SECTION ===
            // Section header
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(15, yPos, 180, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('FINANCIAL SUMMARY', 20, yPos + 8);
            
            yPos += 18;
            doc.setTextColor(0, 0, 0);
            
            // Financial details box
            doc.setFillColor(248, 250, 252);
            doc.rect(15, yPos, 180, 60, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.rect(15, yPos, 180, 60, 'S');
            
            yPos += 12;
            
            // Gross Pay
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text('Gross Pay:', 25, yPos);
            doc.setFont(undefined, 'bold');
            doc.text(Utils.formatCurrency(settlement.grossPay || 0), 150, yPos);
            
            yPos += 10;
            
            // Deductions section
            if (settlement.totalDeductions > 0) {
                doc.setFont(undefined, 'normal');
                doc.text('Deductions:', 25, yPos);
                yPos += 8;
                
                const deductions = [
                    { label: 'Advances', amount: settlement.advances },
                    { label: 'Lumper Fees', amount: settlement.lumperFees },
                    { label: 'Fuel', amount: settlement.fuelDeduction },
                    { label: 'Insurance', amount: settlement.insuranceDeduction },
                    { label: 'Maintenance', amount: settlement.maintenanceDeduction },
                    { label: 'Other Expenses', amount: settlement.otherExpenseDeduction }
                ];
                
                deductions.forEach(deduction => {
                    if (deduction.amount > 0) {
                        doc.text(`  ${deduction.label}:`, 30, yPos);
                        doc.text(`-${Utils.formatCurrency(deduction.amount)}`, 150, yPos);
                        yPos += 6;
                    }
                });
                
                // Total deductions line
                doc.setDrawColor(200, 200, 200);
                doc.line(25, yPos, 180, yPos);
                yPos += 6;
                
                doc.setFont(undefined, 'bold');
                doc.text('Total Deductions:', 25, yPos);
                doc.text(`-${Utils.formatCurrency(settlement.totalDeductions)}`, 150, yPos);
                yPos += 10;
            }
            
            // Net Pay - highlighted
            doc.setFillColor(successColor[0], successColor[1], successColor[2]);
            doc.rect(20, yPos - 2, 160, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('NET PAY:', 25, yPos + 6);
            doc.text(Utils.formatCurrency(settlement.netPay || 0), 150, yPos + 6);
            
            // Reset colors
            doc.setTextColor(0, 0, 0);
            
            // === FOOTER SECTION ===
            yPos = 260;
            
            // Footer background
            doc.setFillColor(248, 250, 252);
            doc.rect(0, yPos, 210, 37, 'F');
            
            yPos += 10;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
            
            doc.text('This settlement is subject to the terms and conditions of your driver agreement.', 20, yPos);
            doc.text('Please contact the office if you have any questions regarding this settlement.', 20, yPos + 6);
            
            // Company footer
            yPos += 15;
            doc.setFont(undefined, 'bold');
            doc.text('ATS FREIGHT LLC', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text('Professional Transportation Services', 20, yPos + 4);
            
            // Save the PDF
            const fileName = `Settlement_${settlement.settlementNumber || settlement.id}_${driverName.replace(/\s+/g, '_')}.pdf`;
            doc.save(fileName);
        }

        // Print All Settlements
        window.printAllSettlements = function() {
            const settlements = DataManager.settlements.filter(s => s.status !== 'draft');
            
            if (settlements.length === 0) {
                Utils.showNotification('No settlements to print', 'warning');
                return;
            }

            if (settlements.length > 10) {
                if (!confirm(`This will generate ${settlements.length} PDF files. Continue?`)) {
                    return;
                }
            }

            let processed = 0;
            Utils.showNotification(`Generating ${settlements.length} settlement PDFs...`, 'info');

            settlements.forEach((settlement, index) => {
                setTimeout(() => {
                    try {
                        generateSettlementPDF(settlement);
                        processed++;
                        
                        if (processed === settlements.length) {
                            Utils.showNotification(`Successfully generated ${processed} settlement PDFs`, 'success');
                        }
                    } catch (error) {
                        console.error(`Error generating PDF for settlement ${settlement.id}:`, error);
                    }
                }, index * 500); // Stagger PDF generation to avoid browser issues
            });
        };

        // Email Settlement
        window.emailSettlement = function(settlementId) {
            const settlement = DataManager.settlements.find(s => s.id === settlementId);
            if (!settlement) {
                Utils.showNotification('Settlement not found', 'error');
                return;
            }

            const driver = DataManager.drivers.find(d => d.id === settlement.driverId);
            const driverName = driver ? `${driver.firstName} ${driver.lastName}` : 'Unknown Driver';
            const driverEmail = driver?.email || '';

            if (!driverEmail) {
                Utils.showNotification('Driver email not found. Please update driver profile.', 'warning');
                return;
            }

            // Create email content
            const subject = `Settlement ${settlement.settlementNumber || settlement.id} - ATS FREIGHT LLC`;
            const body = `Dear ${driverName},

Please find your settlement details below:

Settlement #: ${settlement.settlementNumber || settlement.id}
Period: ${safeFormatDate(settlement.startDate)} - ${safeFormatDate(settlement.endDate)}
Gross Pay: ${Utils.formatCurrency(settlement.grossPay || 0)}
Total Deductions: ${Utils.formatCurrency(settlement.totalDeductions || 0)}
Net Pay: ${Utils.formatCurrency(settlement.netPay || 0)}

Please contact the office if you have any questions.

Best regards,
ATS FREIGHT LLC
(614) 254-0380`;

            // Create mailto link
            const mailtoLink = `mailto:${driverEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.open(mailtoLink);
            
            Utils.showNotification('Email client opened with settlement details', 'success');
        };

        // Email All Settlements
        window.emailAllSettlements = function() {
            const settlements = DataManager.settlements.filter(s => s.status !== 'draft');
            
            if (settlements.length === 0) {
                Utils.showNotification('No settlements to email', 'warning');
                return;
            }

            const driversWithEmail = settlements.filter(settlement => {
                const driver = DataManager.drivers.find(d => d.id === settlement.driverId);
                return driver && driver.email;
            });

            if (driversWithEmail.length === 0) {
                Utils.showNotification('No drivers have email addresses configured', 'warning');
                return;
            }

            if (driversWithEmail.length !== settlements.length) {
                const missingEmails = settlements.length - driversWithEmail.length;
                if (!confirm(`${missingEmails} drivers are missing email addresses. Continue with ${driversWithEmail.length} settlements?`)) {
                    return;
                }
            }

            // Create batch email
            const emailAddresses = driversWithEmail.map(settlement => {
                const driver = DataManager.drivers.find(d => d.id === settlement.driverId);
                return driver.email;
            }).join(',');

            const subject = 'Your Settlement from ATS FREIGHT LLC';
            const body = `Dear Drivers,

Your settlement details are ready for review. Please contact the office for specific settlement information.

ATS FREIGHT LLC
Phone: (614) 254-0380
Email: info@atsfreight.com

Thank you for your service!`;

            const mailtoLink = `mailto:${emailAddresses}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.open(mailtoLink);
            
            Utils.showNotification(`Email client opened for ${driversWithEmail.length} drivers`, 'success');
        };

        // Initialize Settlement Charts
        function initializeSettlementCharts() {
            renderSettlementTrendsChart();
            renderPaymentStatusChart();
        }

        // Render Settlement Trends Chart
        function renderSettlementTrendsChart() {
            const settlements = DataManager.settlements || [];
            
            // Group settlements by week
            const weeklyData = {};
            const today = new Date();
            
            // Generate last 8 weeks
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - (i * 7));
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                
                const weekKey = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;
                
                weeklyData[weekKey] = {
                    week: weekKey,
                    settlements: 0,
                    totalAmount: 0,
                    avgAmount: 0
                };
                
                // Count settlements in this week
                settlements.forEach(settlement => {
                    try {
                        const dateValue = settlement.createdAt || settlement.date;
                        if (!dateValue) return;
                        
                        const settlementDate = new Date(dateValue);
                        if (isNaN(settlementDate.getTime())) {
                            console.warn('Invalid settlement date:', dateValue);
                            return;
                        }
                        
                        if (settlementDate >= weekStart && settlementDate <= weekEnd) {
                            weeklyData[weekKey].settlements++;
                            weeklyData[weekKey].totalAmount += parseFloat(settlement.netPay || 0);
                        }
                    } catch (error) {
                        console.warn('Error processing settlement date:', settlement, error);
                    }
                });
                
                // Calculate average
                if (weeklyData[weekKey].settlements > 0) {
                    weeklyData[weekKey].avgAmount = weeklyData[weekKey].totalAmount / weeklyData[weekKey].settlements;
                }
            }
            
            const weeks = Object.keys(weeklyData);
            const settlementCounts = weeks.map(week => weeklyData[week].settlements);
            const avgAmounts = weeks.map(week => weeklyData[week].avgAmount);
            
            const data = [
                {
                    x: weeks,
                    y: settlementCounts,
                    name: 'Settlements Count',
                    type: 'bar',
                    yaxis: 'y',
                    marker: { color: '#3b82f6' }
                },
                {
                    x: weeks,
                    y: avgAmounts,
                    name: 'Avg Amount',
                    type: 'scatter',
                    mode: 'lines+markers',
                    yaxis: 'y2',
                    line: { color: '#10b981', width: 3 },
                    marker: { color: '#10b981', size: 8 }
                }
            ];
            
            const layout = {
                title: '',
                showlegend: true,
                margin: { t: 20, b: 40, l: 60, r: 60 },
                xaxis: { 
                    title: 'Week',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Number of Settlements',
                    side: 'left',
                    color: '#3b82f6'
                },
                yaxis2: {
                    title: 'Average Amount ($)',
                    side: 'right',
                    overlaying: 'y',
                    color: '#10b981',
                    tickformat: '$,.0f'
                },
                font: { family: 'Inter, sans-serif', size: 12 }
            };
            
            const config = { responsive: true, displayModeBar: false };
            
            Plotly.newPlot('settlementChart', data, layout, config);
        }

        // Render Payment Status Chart
        function renderPaymentStatusChart() {
            const settlements = DataManager.settlements || [];
            
            // Count settlements by status
            const statusCounts = {
                'Paid': 0,
                'Pending': 0,
                'Processed': 0,
                'Draft': 0
            };
            
            settlements.forEach(settlement => {
                const status = settlement.status || 'pending';
                switch (status.toLowerCase()) {
                    case 'paid':
                        statusCounts['Paid']++;
                        break;
                    case 'processed':
                        statusCounts['Processed']++;
                        break;
                    case 'draft':
                        statusCounts['Draft']++;
                        break;
                    default:
                        statusCounts['Pending']++;
                }
            });
            
            const labels = Object.keys(statusCounts);
            const values = Object.values(statusCounts);
            const colors = ['#10b981', '#f59e0b', '#3b82f6', '#6b7280'];
            
            const data = [{
                values: values,
                labels: labels,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: colors,
                    line: {
                        color: '#ffffff',
                        width: 2
                    }
                },
                textinfo: 'label+percent',
                textposition: 'outside',
                textfont: {
                    size: 12,
                    family: 'Inter, sans-serif'
                }
            }];
            
            const layout = {
                title: '',
                showlegend: true,
                margin: { t: 20, b: 20, l: 20, r: 20 },
                font: { family: 'Inter, sans-serif', size: 12 },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.1
                }
            };
            
            const config = { responsive: true, displayModeBar: false };
            
            Plotly.newPlot('paymentStatusChart', data, layout, config);
        }

        // Update charts when data changes
        function updateSettlementCharts() {
            if (typeof Plotly !== 'undefined') {
                initializeSettlementCharts();
            }
        }

        // Refresh all settlements data and charts
        window.refreshSettlements = function() {
            Utils.showNotification('Refreshing settlements data...', 'info');
            
            try {
                // Re-render table
                renderSettlementsTable();
                
                // Update stats
                updateStats();
                
                // Update charts
                updateSettlementCharts();
                
                Utils.showNotification('Settlements refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing settlements:', error);
                Utils.showNotification('Error refreshing settlements', 'error');
            }
        };

        // Delete settlement
        window.deleteSettlement = async function(settlementId) {
            if (!confirm('Are you sure you want to delete this settlement?')) return;
            
            try {
                const settlement = DataManager.settlements.find(s => s.id === settlementId);
                
                // Clear settlementId from associated loads
                if (settlement && settlement.loadIds) {
                    for (const loadId of settlement.loadIds) {
                        await DataManager.updateLoad(loadId, { settlementId: null });
                    }
                }
                
                await DataManager.deleteSettlement(settlementId);
                Utils.showNotification('Settlement deleted', 'success');
                renderSettlementsTable();
            } catch (error) {
                console.error('Error deleting settlement:', error);
                Utils.showNotification('Failed to delete settlement', 'error');
            }
        };

        // Auto-run when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Settlements page ready');
            setupEventListeners();
            
            // Wait for DataManager to be fully initialized
            while (!DataManager || !DataManager.settlements) {
                console.log('Waiting for DataManager to initialize...');
                await new Promise(r => setTimeout(r, 200));
            }
            
            console.log('DataManager ready, rendering settlements table...');
            renderSettlementsTable();
            
            // Initialize charts
            console.log('Initializing settlement charts...');
            initializeSettlementCharts();
            
            // Also set up a listener for when settlements change
            if (DataManager.settlements) {
                console.log('Initial settlements count:', DataManager.settlements.length);
            }
        });
    </script>
</body>

</html>