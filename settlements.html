<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Settlements - ATS FREIGHT LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .bg-navy {
            background-color: #1e3a8a;
        }

        .text-navy {
            color: #1e3a8a;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-paid {
            background-color: #10b981;
        }

        .status-pending {
            background-color: #f59e0b;
        }

        .status-processed {
            background-color: #3b82f6;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC" class="h-12 w-12 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="company-logo" style="display:none; width:48px; height:48px; background:#fff; border-radius:8px; align-items:center; justify-content:center; font-weight:bold; color:#1e3a8a;">ATS</div>
                    <div>
                        <h1 class="text-xl font-bold">ATS FREIGHT LLC</h1>
                        <p class="text-sm opacity-90">Transportation Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="loads.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-truck mr-2"></i>Loads
                    </a>
                    <a href="drivers.html" class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-users mr-2"></i>Drivers
                    </a>
                    <span class="nav-item active px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-calculator mr-2"></i>Settlements
                    </span>
                    <span class="text-sm">Welcome, Liban Ali</span>
                    <button class="nav-item px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Driver Settlements</h2>
                <p class="text-gray-600 mt-2">Manage driver payments and settlements</p>
            </div>
            <div class="flex items-center space-x-4">

                <button onclick="openGenerateSettlementModal()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Generate Settlement
                </button>
            </div>
        </div>

        <!-- Settlement Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">This Week</dt>
                            <dd id="thisWeekTotal" class="text-2xl font-semibold text-gray-900">$0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Settlements</dt>
                            <dd id="totalSettlements" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                            <dd id="pendingSettlements" class="text-2xl font-semibold text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calculator text-purple-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Avg Settlement</dt>
                            <dd id="avgSettlement" class="text-2xl font-semibold text-gray-900">$0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlement Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Weekly Settlement Trends</h3>
                <div id="settlementChart" class="h-64"></div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Status Distribution</h3>
                <div id="paymentStatusChart" class="h-64"></div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Driver</label>
                    <select id="driverFilter"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Drivers</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilter"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processed">Processed</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Week</label>
                    <input type="week" id="weekFilter"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-end">
                    <button
                        class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Settlements Table -->
        <div class="bg-white rounded-lg card-shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Driver Settlements</h3>
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-print mr-2"></i>Print All
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Settlement #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Period</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Miles</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Gross Pay</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Deductions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Net Pay</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="settlementsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-medium">1</span> to <span class="font-medium">4</span> of <span
                            class="font-medium">24</span> settlements
                    </div>
                    <div class="flex space-x-2">
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Previous
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md">
                            1
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            2
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            3
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settlement Detail Modal -->
    <div id="settlementModal" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-semibold">Settlement Details</h3>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Settlement Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">Driver Information</h5>
                        <p class="text-sm text-gray-600" id="selectedDriverName">Select a driver...</p>
                        <p class="text-sm text-gray-600" id="selectedDriverPaymentType">-</p>
                        <p class="text-sm text-gray-600" id="selectedDriverRate">-</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">Settlement Period</h5>
                        <p class="text-sm text-gray-600">Week 42, 2025</p>
                        <p class="text-sm text-gray-600">Oct 14 - Oct 20, 2025</p>
                        <p class="text-sm text-gray-600">Generated: Oct 21, 2025</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">Payment Summary</h5>
                        <p class="text-sm text-gray-600">Gross Pay: $1,925.00</p>
                        <p class="text-sm text-gray-600">Deductions: $1,359.89</p>
                        <p class="text-sm font-bold text-gray-900">Net Pay: $565.11</p>
                    </div>
                </div>

                <!-- Earnings Breakdown -->
                <div class="border-t pt-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Earnings Breakdown</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                            Description</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                            Amount</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Base Pay (2,500 miles × $0.65)</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$1,625.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Fuel Surcharge</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$125.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Detention Pay (2 hrs)</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$75.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Safety Bonus</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$100.00</td>
                                    </tr>
                                    <tr class="bg-gray-50">
                                        <td class="px-4 py-2 text-sm font-semibold text-gray-900">Total Gross Pay</td>
                                        <td class="px-4 py-2 text-sm font-semibold text-gray-900 text-right">$1,925.00
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                            Deduction</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                            Amount</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Fuel Advance</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$800.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Cash Advance</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$200.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Insurance</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$45.00</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Federal Tax</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$144.38</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">State Tax</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$38.25</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Social Security</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$119.35</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900">Medicare</td>
                                        <td class="px-4 py-2 text-sm text-gray-900 text-right">$27.91</td>
                                    </tr>
                                    <tr class="bg-gray-50">
                                        <td class="px-4 py-2 text-sm font-semibold text-gray-900">Total Deductions</td>
                                        <td class="px-4 py-2 text-sm font-semibold text-gray-900 text-right">$1,359.89
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Associated Loads -->
                <div class="border-t pt-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Associated Loads</h4>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Load #</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Miles</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Rate</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Loads will be populated dynamically when driver is selected -->
                        </tbody>
                    </table>
                </div>

                <!-- Form Actions -->
                <div class="border-t pt-6 flex justify-end space-x-4">
                    <button onclick="closeModal()"
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Close
                    </button>
                    <button onclick="downloadSettlement()"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button onclick="printSettlement()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Settlement Modal -->
    <div id="createSettlementModal" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Generate Driver Settlement</h3>
                    <button onclick="closeCreateModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="settlementForm" class="space-y-6">
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Select Driver</label>
                                <button type="button" onclick="debugSettlementData()"
                                    class="text-xs text-blue-600 hover:text-blue-800 underline">
                                    Debug Data
                                </button>
                            </div>
                            <select id="driverSelect"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select a driver...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Select a driver to see all unpaid delivered loads.</p>
                        </div>
                    </div>

                    <div id="settlementLoadsSection" class="hidden">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Available Loads</h4>
                        <div class="overflow-x-auto border rounded-lg mb-6">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                            Select</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Load
                                            #</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date
                                        </th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                            Pay Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="driverLoadsBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                                </tbody>
                            </table>
                        </div>

                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <!-- Pay Breakdown (Read-only) -->
                            <div class="mb-6 pb-4 border-b border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 uppercase mb-3">Pay Breakdown</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Base Driver Pay:</span>
                                        <span id="basePay" class="font-medium text-gray-900">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">+ Detention Pay:</span>
                                        <span id="detentionPay" class="font-medium text-green-600">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deductions -->
                            <div class="mb-6 pb-4 border-b border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 uppercase mb-3">Load Deductions</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Advances:</span>
                                        <span id="advancesTotal" class="font-medium text-red-600">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Lumper Fees:</span>
                                        <span id="lumperTotal" class="font-medium text-red-600">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Driver Expenses -->
                            <div class="mb-6 pb-4 border-b border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 uppercase mb-3">Driver Expenses (Auto-matched to Loads)</h4>
                                <div class="overflow-x-auto border rounded-lg mb-3 max-h-48 overflow-y-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    <input type="checkbox" id="toggleAllExpenses" class="w-4 h-4 text-blue-600 rounded" 
                                                        onchange="toggleAllExpenses(this)">
                                                </th>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Linked Load</th>
                                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="driverExpensesBody" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="6" class="px-4 py-3 text-sm text-gray-500 text-center">
                                                    Select a driver to see expenses
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Selected Expenses:</span>
                                    <span id="expensesTotal" class="font-medium text-red-600">$0.00</span>
                                </div>
                            </div>

                            <!-- Manual Deductions -->
                            <div class="mb-6 pb-4 border-b border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 uppercase mb-3">Manual Deductions</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Fuel</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-2 text-gray-500">$</span>
                                            <input type="number" id="fuelDeduction" value="0" step="0.01"
                                                class="w-full pl-6 pr-3 py-2 border rounded-md focus:ring-blue-500"
                                                oninput="calculateSettlementTotal()">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Insurance</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-2 text-gray-500">$</span>
                                            <input type="number" id="insuranceDeduction" value="" step="0.01" placeholder="Auto-calculated"
                                                class="w-full pl-6 pr-3 py-2 border rounded-md focus:ring-blue-500"
                                                oninput="calculateSettlementTotal()">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Other</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-2 text-gray-500">$</span>
                                            <input type="number" id="otherDeduction" value="0" step="0.01"
                                                class="w-full pl-6 pr-3 py-2 border rounded-md focus:ring-blue-500"
                                                oninput="calculateSettlementTotal()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 pt-4 space-y-2">
                                <div class="flex justify-between text-gray-600">
                                    <span>Gross Pay:</span>
                                    <span id="grossPay" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500">
                                    <span>Total Deductions:</span>
                                    <span id="totalDeductions" class="font-medium">-$45.00</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                    <span class="text-xl font-bold text-gray-900">Net Pay:</span>
                                    <span id="netPay" class="text-2xl font-extrabold text-green-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="noLoadsMessage" class="hidden text-center py-8">
                        <div class="bg-yellow-50 text-yellow-800 p-4 rounded-lg inline-block">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No unpaid delivered loads found for this driver.
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="closeCreateModal()"
                            class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition-colors">
                            Cancel
                        </button>
                        <button type="button" id="generateSettlementBtn"
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Generate Settlement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-8 border-t border-gray-200">
        <div class="text-center">
            <p class="text-gray-600">&copy; 2025 ATS FREIGHT LLC. All rights reserved.</p>
            <p class="text-sm text-gray-500 mt-2">3191 MORSE RD STE 15, COLUMBUS, OH 43231 | (614) 254-0380 | DOT 3169186</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="main.js"></script>
    <script>
        // === FORCE GLOBAL EXPORTS FIRST — THIS FIXES EVERYTHING ===
        // Expose functions immediately so onclick handlers can find them
        // Don't use 'let' - make them implicit globals so they work across the entire script
        var _syncAllDeliveredLoads, _openGenerateSettlementModal;

        window.syncAllDeliveredLoads = function () {
            if (_syncAllDeliveredLoads) return _syncAllDeliveredLoads();
        };
        window.openGenerateSettlementModal = function () {
            if (_openGenerateSettlementModal) return _openGenerateSettlementModal();
        };

        // Define renderSettlements globally BEFORE DOMContentLoaded
        window.renderSettlements = () => {
            renderSettlementsTable();
            updateSettlementStats();
            initializeSettlementCharts();
        };

        // Also refresh charts when loads change (since we track delivered loads)
        window.renderLoads = () => {
            updateSettlementStats();
            initializeSettlementCharts();
        };

        // Refresh charts when drivers change (needed for pay calculation)
        window.renderDrivers = () => {
            initializeSettlementCharts();
        };

        // Initialize charts
        document.addEventListener('DOMContentLoaded', async () => {
            Auth.init();
            await DataManager.init();

            // Now we can safely call renderSettlements
            if (window.renderSettlements) window.renderSettlements();

            // Explicitly attach event listener for driver selection
            const driverSelect = document.getElementById('driverSelect');
            if (driverSelect) {
                driverSelect.addEventListener('change', () => {
                    loadDriverUnpaidLoads();
                    if (window.loadDriverExpenses) loadDriverExpenses(); // Load expenses when driver is selected
                    // Auto-populate insurance based on driver type
                    const driverId = driverSelect.value;
                    if (driverId) {
                        const driver = DataManager.drivers.find(d => d.id === driverId);
                        const isOwnerOperator = driver?.payment?.type === 'percentage' || driver?.payment?.type === 'owner_operator';
                        const insuranceField = document.getElementById('insuranceDeduction');
                        if (insuranceField) {
                            if (isOwnerOperator) {
                                insuranceField.value = '0';
                                insuranceField.placeholder = 'Owner Operator (No Insurance)';
                            } else {
                                insuranceField.value = '45.00';
                                insuranceField.placeholder = 'Auto-calculated';
                            }
                            calculateSettlementTotal(); // Recalculate with new insurance
                        }
                        
                        // Update driver info display
                        if (driver) {
                            const driverNameEl = document.getElementById('selectedDriverName');
                            const paymentTypeEl = document.getElementById('selectedDriverPaymentType');
                            const rateEl = document.getElementById('selectedDriverRate');
                            
                            if (driverNameEl) {
                                driverNameEl.textContent = `${driver.firstName} ${driver.lastName} (${driver.driverNumber || 'No ID'})`;
                            }
                            if (paymentTypeEl) {
                                const paymentType = driver.payment?.type || 'per_mile';
                                paymentTypeEl.textContent = `Payment Type: ${paymentType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                            }
                            if (rateEl) {
                                if (driver.payment?.type === 'percentage') {
                                    rateEl.textContent = `Rate: ${driver.payment.percentage || driver.payment.rate || 75}%`;
                                } else {
                                    rateEl.textContent = `Rate: ${Utils.formatCurrency(driver.payment?.perMileRate || 0.65)}/mile`;
                                }
                            }
                        }
                    } else {
                        // Reset driver info display
                        document.getElementById('selectedDriverName').textContent = 'Select a driver...';
                        document.getElementById('selectedDriverPaymentType').textContent = '-';
                        document.getElementById('selectedDriverRate').textContent = '-';
                    }
                });
            }
        });

        function updateSettlementStats() {
            const settlements = DataManager.settlements || [];

            // Calculate this week's total
            const now = new Date();
            const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const thisWeekSettlements = settlements.filter(s => {
                const settlementDate = new Date(s.createdAt);
                return settlementDate >= weekStart;
            });
            const thisWeekTotal = thisWeekSettlements.reduce((sum, s) => sum + (s.netPay || 0), 0);

            // Count total settlements
            const totalSettlements = settlements.length;

            // Count pending settlements
            const pendingCount = settlements.filter(s => s.status === 'pending').length;

            // Calculate average settlement
            const avgSettlement = totalSettlements > 0
                ? settlements.reduce((sum, s) => sum + (s.netPay || 0), 0) / totalSettlements
                : 0;

            // Update UI
            document.getElementById('thisWeekTotal').textContent = Utils.formatCurrency(thisWeekTotal);
            document.getElementById('totalSettlements').textContent = totalSettlements;
            document.getElementById('pendingSettlements').textContent = pendingCount;
            document.getElementById('avgSettlement').textContent = Utils.formatCurrency(avgSettlement);
        }

        function renderSettlementsTable() {
            const tbody = document.getElementById('settlementsTableBody');
            tbody.innerHTML = '';

            DataManager.settlements.forEach(settlement => {
                const statusClass = {
                    'paid': 'status-paid',
                    'pending': 'status-pending',
                    'processed': 'status-processed'
                }[settlement.status] || 'bg-gray-500';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${settlement.settlementNumber}</div>
                        <div class="text-sm text-gray-500">Generated: ${Utils.formatDate(settlement.createdAt)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${settlement.driverName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${settlement.period?.display || (settlement.period?.startDate && settlement.period?.endDate ? Utils.formatDateRange(settlement.period.startDate, settlement.period.endDate) : 'N/A')}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${settlement.totalMiles || 0}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${Utils.formatCurrency(settlement.grossPay)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${Utils.formatCurrency(settlement.totalDeductions)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">${Utils.formatCurrency(settlement.netPay)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full text-white ${statusClass}">
                            ${settlement.status.charAt(0).toUpperCase() + settlement.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewSettlement('${settlement.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadSettlement('${settlement.id}')" class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="printSettlement('${settlement.id}')" class="text-purple-600 hover:text-purple-900 mr-3">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="deleteSettlement('${settlement.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        _openGenerateSettlementModal = function openCreateSettlementModal() {
            const modal = document.getElementById('createSettlementModal');
            const select = document.getElementById('driverSelect');

            // Reset everything
            document.getElementById('settlementLoadsSection').classList.add('hidden');
            document.getElementById('noLoadsMessage').classList.add('hidden');
            document.getElementById('driverLoadsBody').innerHTML = '';
            const expensesBody = document.getElementById('driverExpensesBody');
            if (expensesBody) {
                expensesBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-3 text-sm text-gray-500 text-center">
                            Select a driver to see expenses
                        </td>
                    </tr>
                `;
            }
            document.getElementById('expensesTotal').textContent = '$0.00';
            document.getElementById('grossPay').textContent = '$0.00';
            document.getElementById('totalDeductions').textContent = '-$' + (parseFloat(document.getElementById('insuranceDeduction').value) || 45).toFixed(2);
            document.getElementById('netPay').textContent = '$0.00';
            document.getElementById('fuelDeduction').value = '0';
            document.getElementById('otherDeduction').value = '0';
            document.getElementById('generateSettlementBtn').disabled = true;

            // Populate drivers
            select.innerHTML = '<option value="">Select a driver...</option>';
            DataManager.drivers.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = `${d.firstName} ${d.lastName} (${d.driverNumber || 'No ID'})`;
                select.appendChild(opt);
            });

            modal.classList.add('show');
        }

        function closeCreateModal() {
            document.getElementById('createSettlementModal').classList.remove('show');
        }

        // NOTE: loadDriverUnpaidLoads and calculateSettlementTotal are now in main.js



        /* ----------  NEW : show EVERY unpaid delivered load as soon as modal opens  ---------- */
        const createModal = document.getElementById('createSettlementModal');
        // Bootstrap 5 event for modal shown
        // If using a custom modal class, we can also just rely on the open function calling it
        // But adding this listener is safe
        // createModal.addEventListener('shown.bs.modal', loadAllUnsettledDeliveredLoads); 

        // We already call loadAllUnsettledDeliveredLoads() inside openCreateSettlementModal()
        // so we don't strictly need the listener if we control the open function, 
        // but following user instructions to ensure it works.

        document.getElementById('generateSettlementBtn').addEventListener('click', async () => {
            const driverId = document.getElementById('driverSelect').value;
            if (!driverId) { Utils.showNotification('Choose a driver first', 'warning'); return; }

            const checked = document.querySelectorAll('.settlement-checkbox:checked');
            if (checked.length === 0) { Utils.showNotification('Select at least one load', 'warning'); return; }

            // Get selected expenses
            const checkedExpenses = document.querySelectorAll('.expense-checkbox:checked');
            const expenseIds = Array.from(checkedExpenses).map(cb => cb.value);
            
            // Calculate expenses total
            let expensesTotal = 0;
            checkedExpenses.forEach(cb => {
                expensesTotal += parseFloat(cb.dataset.amount || 0);
            });

            // Calculate all components
            const loadIds = Array.from(checked).map(cb => cb.value);

            let basePay = 0;
            let detentionTotal = 0;
            let advancesTotal = 0;
            let lumperTotal = 0;
            let totalMiles = 0;

            checked.forEach(cb => {
                basePay += parseFloat(cb.dataset.basePay || 0);
                detentionTotal += parseFloat(cb.dataset.detention || 0);
                advancesTotal += parseFloat(cb.dataset.advance || 0);
                lumperTotal += parseFloat(cb.dataset.lumper || 0);
                totalMiles += parseFloat(cb.dataset.miles || 0);
            });

            const grossPay = basePay + detentionTotal;

            // Manual deductions
            const fuel = parseFloat(document.getElementById('fuelDeduction').value) || 0;
            const insurance = parseFloat(document.getElementById('insuranceDeduction').value) || 0;
            const other = parseFloat(document.getElementById('otherDeduction').value) || 0;

            // Calculate tax deductions based on driver type
            const driver = DataManager.drivers.find(d => d.id === driverId);
            const isOwnerOperator = driver?.payment?.type === 'percentage' || driver?.payment?.type === 'owner_operator';
            
            // Tax calculations (only for company drivers, not owner operators)
            const taxes = {
                federal: isOwnerOperator ? 0 : grossPay * 0.075, // 7.5% federal tax
                state: isOwnerOperator ? 0 : grossPay * 0.02,     // 2% state tax
                socialSecurity: isOwnerOperator ? 0 : grossPay * 0.062, // 6.2% social security
                medicare: isOwnerOperator ? 0 : grossPay * 0.0145  // 1.45% medicare
            };
            
            const totalTaxes = Object.values(taxes).reduce((sum, tax) => sum + tax, 0);
            
            // Auto-calculate insurance if not manually entered (only for company drivers)
            let insuranceDeduction = insurance;
            if (!insurance && !isOwnerOperator) {
                insuranceDeduction = 45.00; // Default insurance deduction for company drivers
            }

            const totalDeductions = advancesTotal + lumperTotal + expensesTotal + fuel + insuranceDeduction + other + totalTaxes;
            const netPay = grossPay - totalDeductions;

            // Calculate settlement period (week start and end dates)
            const now = new Date();
            const weekStart = Utils.getWeekStart(now);
            const weekEnd = Utils.getWeekEnd(weekStart);

            const settlementData = {
                settlementNumber: 'ST-' + new Date().getFullYear() + '-' + (DataManager.settlements.length + 1001),
                driverId,
                driverName: document.getElementById('driverSelect').options[document.getElementById('driverSelect').selectedIndex].text,
                period: {
                    startDate: weekStart.toISOString(),
                    endDate: weekEnd.toISOString(),
                    weekNumber: Utils.getWeekNumber(now),
                    year: now.getFullYear(),
                    display: Utils.formatDateRange(weekStart, weekEnd)
                },
                loadIds,
                expenseIds, // Include expense IDs
                basePay,
                detentionPay: detentionTotal,
                grossPay,
                deductions: {
                    advances: advancesTotal,
                    lumperFees: lumperTotal,
                    expenses: expensesTotal, // Include expenses in deductions
                    fuel: fuel,
                    insurance: insuranceDeduction,
                    other: other,
                    taxes: taxes
                },
                totalDeductions,
                netPay,
                totalMiles,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            try {
                const id = await DataManager.addSettlement(settlementData);
                // mark loads as paid
                for (const loadId of loadIds) await DataManager.updateLoad(loadId, { settlementId: id });
                // mark expenses as included in settlement
                for (const expenseId of expenseIds) {
                    await DataManager.updateExpense(expenseId, { settlementId: id });
                }
                Utils.showNotification('Settlement created successfully', 'success');
                // keep modal open – user closes with Cancel

                // Refresh the list to remove paid loads and expenses
                loadDriverUnpaidLoads();
                if (window.loadDriverExpenses) loadDriverExpenses();
                renderSettlements();
                updateSettlementStats();
            } catch (e) {
                Utils.showNotification('Error: ' + e.message, 'error');
            }
        });

        function downloadSettlement(settlementId) {
            const settlement = DataManager.getSettlement(settlementId);
            if (!settlement) return;

            const driver = DataManager.drivers.find(d => d.id === settlement.driverId);
            const loads = settlement.loadIds?.map(id => DataManager.getLoad(id)).filter(Boolean) || [];
            const expenses = settlement.expenseIds?.map(id => DataManager.getExpense(id)).filter(Boolean) || [];

            const printWindow = window.open('', '_blank');
            const formatCurrency = (amt) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amt || 0);
            const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Format period display
            let periodDisplay = settlement.period?.display;
            if (!periodDisplay && settlement.period?.startDate && settlement.period?.endDate) {
                periodDisplay = Utils.formatDateRange(settlement.period.startDate, settlement.period.endDate);
            } else if (!periodDisplay) {
                periodDisplay = settlement.period || 'N/A';
            }

            // Helper to calculate driver pay correctly
            const calculateDriverPay = (load) => {
                if (!driver) return 0;
                const totalRate = parseFloat(load.rate?.total) || 0;
                const miles = parseFloat(load.mileage?.total) || 0;

                if (driver.payment?.type === 'percentage' && totalRate > 0) {
                    const rawValue = driver.payment.percentage;
                    let percentage = 0;
                    // Robust percentage parsing
                    if (typeof rawValue === 'string' && rawValue.includes('%')) {
                        percentage = parseFloat(rawValue.replace('%', '')) / 100;
                    } else {
                        const numValue = parseFloat(rawValue);
                        // If value is > 1, assume it's a percentage (e.g., 40 means 40%)
                        percentage = numValue > 1 ? numValue / 100 : numValue;
                    }
                    return totalRate * percentage;
                } else {
                    const ratePerMile = parseFloat(driver.payment?.perMileRate) || 0.64;
                    return miles * ratePerMile;
                }
            };

            // Get deduction details
            const deductions = settlement.deductions || {};
            const taxes = deductions.taxes || {};

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Settlement ${settlement.settlementNumber}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            padding: 15px; 
                            line-height: 1.2; 
                            color: #333;
                            background: #fff;
                            font-size: 12px;
                        }
                        .header { 
                            display: flex; 
                            justify-content: space-between; 
                            border-bottom: 3px solid #1e3a8a; 
                            padding-bottom: 8px; 
                            margin-bottom: 10px; 
                        }
                        .company h1 { 
                            margin: 0 0 3px 0; 
                            color: #1e3a8a; 
                            font-size: 24px; 
                            font-weight: 700;
                            line-height: 1.2;
                        }
                        .company p {
                            color: #666;
                            font-size: 11px;
                            line-height: 1.3;
                            margin: 2px 0;
                        }
                        .settlement-info {
                            text-align: right;
                        }
                        .settlement-info h2 { 
                            margin: 0 0 3px 0; 
                            color: #1e3a8a; 
                            font-size: 18px;
                            font-weight: 600;
                            line-height: 1.2;
                        }
                        .settlement-info p {
                            color: #666;
                            font-size: 11px;
                            line-height: 1.3;
                            margin: 2px 0;
                        }
                        .driver-info {
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-radius: 4px;
                            margin-bottom: 10px;
                        }
                        .driver-info h3 {
                            color: #1e3a8a;
                            font-size: 14px;
                            margin-bottom: 4px;
                            line-height: 1.2;
                        }
                        .driver-info p {
                            color: #666;
                            font-size: 11px;
                            margin: 2px 0;
                            line-height: 1.3;
                        }
                        .section {
                            margin: 10px 0;
                        }
                        .section-title {
                            color: #1e3a8a;
                            font-size: 14px;
                            font-weight: 600;
                            margin-bottom: 6px;
                            padding-bottom: 4px;
                            border-bottom: 1px solid #e5e7eb;
                            line-height: 1.2;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 8px 0; 
                            background: #fff;
                            font-size: 11px;
                        }
                        th, td { 
                            border: 1px solid #e5e7eb; 
                            padding: 4px 6px; 
                            text-align: left; 
                            line-height: 1.2;
                        }
                        th { 
                            background-color: #1e3a8a;
                            color: #fff;
                            font-weight: 600;
                            text-transform: uppercase;
                            font-size: 10px;
                            letter-spacing: 0.3px;
                            padding: 5px 6px;
                        }
                        td {
                            color: #333;
                            font-size: 11px;
                        }
                        tbody tr:nth-child(even) {
                            background-color: #f9fafb;
                        }
                        .amount {
                            text-align: right;
                            font-weight: 500;
                        }
                        .summary-box {
                            background: #f8f9fa;
                            border: 1px solid #e5e7eb;
                            border-radius: 4px;
                            padding: 10px;
                            margin: 10px 0;
                        }
                        .summary-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 3px 0;
                            border-bottom: 1px solid #e5e7eb;
                            font-size: 11px;
                            line-height: 1.2;
                        }
                        .summary-row:last-child {
                            border-bottom: none;
                        }
                        .summary-row.total {
                            font-size: 13px;
                            font-weight: 600;
                            padding-top: 6px;
                            margin-top: 4px;
                            border-top: 2px solid #1e3a8a;
                        }
                        .summary-label {
                            color: #666;
                        }
                        .summary-value {
                            color: #333;
                            font-weight: 500;
                        }
                        .summary-value.positive {
                            color: #10b981;
                        }
                        .summary-value.negative {
                            color: #ef4444;
                        }
                        .net-pay-box {
                            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
                            color: #fff;
                            padding: 12px;
                            border-radius: 4px;
                            text-align: center;
                            margin-top: 10px;
                        }
                        .net-pay-label {
                            font-size: 12px;
                            opacity: 0.9;
                            margin-bottom: 4px;
                            line-height: 1.2;
                        }
                        .net-pay-amount {
                            font-size: 28px;
                            font-weight: 700;
                            line-height: 1.2;
                        }
                        .footer {
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px solid #e5e7eb;
                            text-align: center;
                            color: #666;
                            font-size: 10px;
                            line-height: 1.2;
                        }
                        @media print { 
                            body { padding: 10px; }
                            .section { page-break-inside: avoid; margin: 8px 0; }
                            .summary-box { page-break-inside: avoid; margin: 8px 0; }
                            .net-pay-box { page-break-inside: avoid; margin: 8px 0; }
                            table { margin: 6px 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company">
                            <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                                <img src="resources/ats-freight-logo.png" alt="ATS FREIGHT LLC" style="height:60px; width:auto;" onerror="this.style.display='none';">
                                <div>
                                    <h1 style="margin:0; color:#1e3a8a; font-size:28px; font-weight:700;">ATS FREIGHT LLC</h1>
                                    <p style="margin:5px 0 0 0; color:#666; font-size:12px;">DOT 3169186</p>
                                </div>
                            </div>
                            <p style="margin:0; color:#666; font-size:12px; line-height:1.6;">3191 MORSE RD STE 15<br>COLUMBUS, OH 43231<br>Phone: (614) 254-0380</p>
                        </div>
                        <div class="settlement-info">
                            <h2>DRIVER SETTLEMENT</h2>
                            <p><strong>Settlement #:</strong> ${settlement.settlementNumber}<br>
                            <strong>Date:</strong> ${formatDate(settlement.createdAt)}<br>
                            <strong>Period:</strong> ${periodDisplay}</p>
                        </div>
                    </div>

                    <div class="driver-info">
                        <h3>Driver Information</h3>
                        <p><strong>Name:</strong> ${settlement.driverName}</p>
                        <p><strong>Driver ID:</strong> ${driver?.driverNumber || 'N/A'}</p>
                        <p><strong>Total Miles:</strong> ${settlement.totalMiles || 0}</p>
                    </div>

                    <div class="section">
                        <h3 class="section-title">Earnings Breakdown</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th class="amount">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Base Driver Pay</td>
                                    <td class="amount">${formatCurrency(settlement.basePay || 0)}</td>
                                </tr>
                                ${settlement.detentionPay > 0 ? `
                                <tr>
                                    <td>Detention Pay</td>
                                    <td class="amount">${formatCurrency(settlement.detentionPay)}</td>
                                </tr>
                                ` : ''}
                                <tr style="background-color: #e0f2fe; font-weight: 600;">
                                    <td>Total Gross Pay</td>
                                    <td class="amount">${formatCurrency(settlement.grossPay)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    ${loads.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">Associated Loads</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Load #</th>
                                    <th>Date</th>
                                    <th>Route</th>
                                    <th class="amount">Gross Rate</th>
                                    <th class="amount">Driver Pay</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loads.map(l => `<tr>
                                    <td>${l.loadNumber || 'N/A'}</td>
                                    <td>${formatDate(l.delivery?.date || l.updatedAt || l.createdAt)}</td>
                                    <td>${(l.pickup?.city || 'N/A')} → ${(l.delivery?.city || 'N/A')}</td>
                                    <td class="amount">${formatCurrency(l.rate?.total || 0)}</td>
                                    <td class="amount">${formatCurrency(calculateDriverPay(l))}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    ${expenses.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">Expenses</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th class="amount">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenses.map(e => {
                                    const expDate = e.date || e.createdAt;
                                    const expType = (e.type || 'other').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    const expDesc = e.description || e.subcategory || e.vendor?.name || expType;
                                    return `<tr>
                                        <td>${formatDate(expDate)}</td>
                                        <td>${expType}</td>
                                        <td>${expDesc}</td>
                                        <td class="amount">${formatCurrency(e.amount || 0)}</td>
                                    </tr>`;
                                }).join('')}
                                <tr style="background-color: #fee2e2; font-weight: 600;">
                                    <td colspan="3">Total Expenses</td>
                                    <td class="amount">${formatCurrency(deductions.expenses || 0)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <div class="section">
                        <h3 class="section-title">Deductions Breakdown</h3>
                        <div class="summary-box">
                            ${deductions.advances > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Advances</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.advances)}</span>
                            </div>
                            ` : ''}
                            ${deductions.lumperFees > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Lumper Fees</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.lumperFees)}</span>
                            </div>
                            ` : ''}
                            ${deductions.expenses > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Expenses</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.expenses)}</span>
                            </div>
                            ` : ''}
                            ${deductions.fuel > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Fuel Deduction</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.fuel)}</span>
                            </div>
                            ` : ''}
                            ${deductions.insurance > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Insurance</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.insurance)}</span>
                            </div>
                            ` : ''}
                            ${deductions.other > 0 ? `
                            <div class="summary-row">
                                <span class="summary-label">Other Deductions</span>
                                <span class="summary-value negative">-${formatCurrency(deductions.other)}</span>
                            </div>
                            ` : ''}
                            ${taxes.federal > 0 || taxes.state > 0 || taxes.socialSecurity > 0 || taxes.medicare > 0 ? `
                            <div class="summary-row" style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #d1d5db;">
                                <span class="summary-label" style="font-weight: 600;">Taxes:</span>
                                <span></span>
                            </div>
                            ${taxes.federal > 0 ? `
                            <div class="summary-row" style="padding-left: 20px;">
                                <span class="summary-label">Federal Tax</span>
                                <span class="summary-value negative">-${formatCurrency(taxes.federal)}</span>
                            </div>
                            ` : ''}
                            ${taxes.state > 0 ? `
                            <div class="summary-row" style="padding-left: 20px;">
                                <span class="summary-label">State Tax</span>
                                <span class="summary-value negative">-${formatCurrency(taxes.state)}</span>
                            </div>
                            ` : ''}
                            ${taxes.socialSecurity > 0 ? `
                            <div class="summary-row" style="padding-left: 20px;">
                                <span class="summary-label">Social Security</span>
                                <span class="summary-value negative">-${formatCurrency(taxes.socialSecurity)}</span>
                            </div>
                            ` : ''}
                            ${taxes.medicare > 0 ? `
                            <div class="summary-row" style="padding-left: 20px;">
                                <span class="summary-label">Medicare</span>
                                <span class="summary-value negative">-${formatCurrency(taxes.medicare)}</span>
                            </div>
                            ` : ''}
                            ` : ''}
                            <div class="summary-row total">
                                <span class="summary-label" style="font-weight: 600; color: #1e3a8a;">Total Deductions</span>
                                <span class="summary-value negative" style="font-weight: 600;">-${formatCurrency(settlement.totalDeductions || 0)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="net-pay-box">
                        <div class="net-pay-label">NET PAY</div>
                        <div class="net-pay-amount">${formatCurrency(settlement.netPay)}</div>
                    </div>

                    <div class="footer">
                        <p>This is a computer-generated settlement statement. Please review all items carefully.</p>
                        <p>Generated on ${new Date().toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' })}</p>
                    </div>

                    <script>window.onload = () => window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printSettlement(settlementId) {
            downloadSettlement(settlementId);
        }

        async function deleteSettlement(settlementId) {
            if (!confirm('Delete this settlement? This will also unlink all associated loads.')) return;

            try {
                const settlement = DataManager.getSettlement(settlementId);
                if (!settlement) {
                    Utils.showNotification('Settlement not found', 'error');
                    return;
                }

                // Unlink all loads from this settlement (handle missing loads gracefully)
                if (settlement.loadIds && settlement.loadIds.length > 0) {
                    for (const loadId of settlement.loadIds) {
                        try {
                            // Check if load exists before trying to update
                            const load = DataManager.getLoad(loadId);
                            if (load) {
                                await DataManager.updateLoad(loadId, { settlementId: null });
                            } else {
                                console.warn(`Load ${loadId} not found, skipping unlink`);
                            }
                        } catch (err) {
                            console.warn(`Error unlinking load ${loadId}:`, err);
                            // Continue with other loads even if one fails
                        }
                    }
                }

                // Unlink all expenses from this settlement (handle missing expenses gracefully)
                if (settlement.expenseIds && settlement.expenseIds.length > 0) {
                    for (const expenseId of settlement.expenseIds) {
                        try {
                            // Check if expense exists before trying to update
                            const expense = DataManager.getExpense(expenseId);
                            if (expense) {
                                await DataManager.updateExpense(expenseId, { settlementId: null });
                            } else {
                                console.warn(`Expense ${expenseId} not found, skipping unlink`);
                            }
                        } catch (err) {
                            console.warn(`Error unlinking expense ${expenseId}:`, err);
                            // Continue with other expenses even if one fails
                        }
                    }
                }

                // Delete the settlement (this function now handles missing loads internally)
                await DataManager.deleteSettlement(settlementId);

                // Refresh the UI
                if (window.renderSettlements) window.renderSettlements();

                Utils.showNotification('Settlement deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting settlement:', error);
                Utils.showNotification('Error deleting settlement: ' + error.message, 'error');
            }
        }

        // Expose to global scope
        window.deleteSettlement = deleteSettlement;

        function viewSettlement(settlementId) {
            const settlement = DataManager.getSettlement(settlementId);
            if (!settlement) return;

            document.getElementById('modalTitle').textContent = 'Settlement Details - ' + settlement.settlementNumber;
            downloadSettlement(settlementId);
        }

        function closeModal() {
            document.getElementById('settlementModal').classList.remove('show');
        }

        function initializeSettlementCharts() {
            // --- 1. Weekly Settlement Trends (Delivered Loads Value) ---
            const weeklyData = {};
            const weeks = [];
            const currentWeek = Utils.getWeekNumber(new Date());

            // Initialize last 5 weeks
            for (let i = 4; i >= 0; i--) {
                const w = currentWeek - i;
                // Handle year wrap roughly (e.g. Week -2 becomes Week 50)
                const adjustedWeek = w > 0 ? w : 52 + w;
                const label = `Week ${adjustedWeek}`;
                weeklyData[label] = 0;
                weeks.push(label);
            }

            // Aggregate Delivered Loads (Settled or Unsettled)
            const deliveredLoads = DataManager.loads.filter(l => {
                const status = (l.status || '').toLowerCase();
                return status === 'delivered' || l.settlementId;
            });

            console.log('Chart Debug: Total Loads:', DataManager.loads.length);
            console.log('Chart Debug: Delivered Loads:', deliveredLoads.length);

            deliveredLoads.forEach(loadRef => {
                // Get fresh load data to ensure we have all properties (fix for NaN issue)
                const load = DataManager.loads.find(l => l.id === loadRef.id) || loadRef;

                const dateStr = load.delivery?.date || load.updatedAt || new Date();
                const date = new Date(dateStr);
                const weekNum = Utils.getWeekNumber(date);
                const label = `Week ${weekNum}`;

                if (weeklyData.hasOwnProperty(label)) {
                    // Calculate driver pay correctly based on driver's payment settings
                    let pay = parseFloat(load.rate?.driverPay) || 0;

                    // If driverPay not set, calculate it
                    if (!pay && load.driverId) {
                        const driver = DataManager.drivers.find(d => d.id === load.driverId);
                        const totalRate = parseFloat(load.rate?.total) || 0;
                        const miles = parseFloat(load.mileage?.total) || 0;

                        if (driver && driver.payment) {
                            // Debug driver structure
                            if (driver.payment.type === 'percentage' && !driver.payment.percentage && !driver.payment.rate) {
                                console.log('Chart Debug: Driver missing percentage/rate:', driver);
                            }

                            if (driver.payment.type === 'percentage') {
                                const totalRate = parseFloat(load.rate?.total) || 0;
                                // Check both percentage and rate properties
                                const rawValue = driver.payment.percentage || driver.payment.rate;
                                let percentage = 0;

                                // Robust percentage parsing
                                if (typeof rawValue === 'string' && rawValue.includes('%')) {
                                    percentage = parseFloat(rawValue.replace('%', '')) / 100;
                                } else {
                                    const numValue = parseFloat(rawValue);
                                    // If value is > 1, assume it's a percentage (e.g., 40 means 40%)
                                    percentage = numValue > 1 ? numValue / 100 : numValue;
                                }

                                pay = totalRate * percentage;
                                console.log(`Chart Debug: Load ${load.loadNumber} | Rate: ${totalRate} | Pct: ${percentage} | Pay: ${pay}`);
                            } else if (miles > 0) {
                                const ratePerMile = parseFloat(driver.payment.perMileRate) || 0.64;
                                pay = miles * ratePerMile;
                            }
                        }
                    }

                    console.log(`Chart Debug: Load ${load.loadNumber} (Week ${weekNum}): Pay $${pay}`);
                    weeklyData[label] += pay;
                } else {
                    console.warn(`Chart Debug: Week ${weekNum} not in range`, Object.keys(weeklyData));
                }
            });

            const trendData = {
                x: weeks,
                y: weeks.map(w => weeklyData[w]),
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#3b82f6', width: 3 },
                marker: { color: '#3b82f6', size: 8 },
                name: 'Delivered Value'
            };

            const settlementLayout = {
                margin: { t: 20, r: 20, b: 40, l: 60 },
                xaxis: { title: 'Week' },
                yaxis: { title: 'Driver Pay Amount ($)' },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('settlementChart', [trendData], settlementLayout, { responsive: true, displayModeBar: false });

            // --- 2. Payment Status Distribution ---
            let paidTotal = 0;
            let processedTotal = 0;
            let pendingTotal = 0;

            // Sum from Settlements
            DataManager.settlements.forEach(s => {
                const status = (s.status || '').toLowerCase();
                const pay = parseFloat(s.netPay) || 0;
                if (status === 'paid') paidTotal += pay;
                else if (status === 'processed') processedTotal += pay;
                else if (status === 'pending') pendingTotal += pay;
            });

            // Add Unsettled Delivered Loads to Pending
            const unsettledLoads = DataManager.loads.filter(l => {
                const status = (l.status || '').toLowerCase();
                return status === 'delivered' && !l.settlementId;
            });

            unsettledLoads.forEach(l => {
                const pay = parseFloat(l.rate?.driverPay) || (parseFloat(l.rate?.total) * 0.75) || 0;
                pendingTotal += pay;
            });

            const paymentStatusData = [{
                values: [paidTotal, pendingTotal, processedTotal],
                labels: ['Paid', 'Pending', 'Processed'],
                type: 'pie',
                marker: {
                    colors: ['#10b981', '#f59e0b', '#3b82f6']
                },
                textinfo: 'label+percent',
                textposition: 'outside',
                hovertemplate: '%{label}: $%{value:,.2f}<extra></extra>'
            }];

            const paymentStatusLayout = {
                margin: { t: 20, r: 20, b: 20, l: 20 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.1 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('paymentStatusChart', paymentStatusData, paymentStatusLayout, {
                responsive: true, displayModeBar: false
            });
        }

        // Sync all delivered loads to settlements
        _syncAllDeliveredLoads = async function syncAllDeliveredLoads() {
            if (!confirm('This will process ALL delivered loads and update settlements. Continue?')) return;

            // FIX 1: Accept "Delivered", "delivered", "DELIVERED", etc.
            const deliveredLoads = DataManager.loads.filter(l => {
                const status = (l.status || '').toString().toLowerCase().trim();
                return status === 'delivered' || status.includes('deliver');
            });

            if (deliveredLoads.length === 0) {
                Utils.showNotification('No delivered loads found in the system', 'warning');
                return;
            }

            Utils.showNotification(`Processing ${deliveredLoads.length} delivered loads...`, 'info');
            let processed = 0;
            let skipped = 0;

            for (const load of deliveredLoads) {
                // FIX 2: Make sure driver exists and has payment settings
                const driver = DataManager.drivers.find(d => d.id === load.driverId);
                if (!driver || !load.driverId) {
                    skipped++;
                    console.log(`Skipped ${load.loadNumber} - no driver assigned`);
                    continue;
                }

                // FIX 3: Safely get rate and miles
                const totalRate = parseFloat(load.rate?.total) || 0;
                const miles = parseFloat(load.mileage?.total) || 0;

                let driverPay = 0;
                // FIX: Handle both "65" and "65%" formats
                if (driver.payment?.type === 'percentage' && totalRate > 0) {
                    // Check both percentage and rate properties
                    const rawValue = driver.payment.percentage || driver.payment.rate;
                    console.log(`DEBUG: Driver ${driver.firstName} ${driver.lastName}`);
                    console.log(`  Payment type: ${driver.payment.type}`);
                    console.log(`  Raw percentage value: "${rawValue}" (type: ${typeof rawValue})`);
                    console.log(`  Load total: $${totalRate}`);

                    let percentage = 0;
                    if (typeof rawValue === 'string' && rawValue.includes('%')) {
                        percentage = parseFloat(rawValue.replace('%', '')) / 100;
                        console.log(`  Detected % symbol, percentage = ${percentage}`);
                    } else {
                        const numValue = parseFloat(rawValue);
                        // If value is > 1, assume it's a percentage (e.g., 40 means 40%)
                        percentage = numValue > 1 ? numValue / 100 : numValue;
                        console.log(`  No % symbol, percentage = ${percentage}`);
                    }
                    driverPay = totalRate * percentage;
                    console.log(`  Final driver pay: $${driverPay.toFixed(2)} (${totalRate} × ${percentage})`);
                } else if (miles > 0) {
                    const ratePerMile = parseFloat(driver.payment?.perMileRate) || 0.64;
                    driverPay = miles * ratePerMile;
                    console.log(`DEBUG: Per-mile driver ${driver.firstName}: ${miles} miles × $${ratePerMile} = $${driverPay.toFixed(2)}`);
                } else {
                    skipped++;
                    console.log(`Skipped ${load.loadNumber} - no rate or miles`);
                    continue;
                }

                // Get week from delivery date or today
                const loadDate = load.delivery?.date || load.updatedAt || new Date();
                const weekStart = Utils.getWeekStart(new Date(loadDate));
                const weekKey = weekStart.toISOString().split('T')[0];

                // Find or create settlement
                let settlement = DataManager.settlements.find(s =>
                    s.driverId === load.driverId &&
                    s.weekStart === weekKey
                );

                if (!settlement) {
                    const weekEnd = Utils.getWeekEnd(weekStart);
                    settlement = {
                        settlementNumber: `ST-${new Date().getFullYear()}-${String(DataManager.settlements.length + 1000).padStart(4, '0')}`,
                        driverId: load.driverId,
                        driverName: `${driver.firstName} ${driver.lastName}`,
                        period: {
                            startDate: weekStart.toISOString(),
                            endDate: weekEnd.toISOString(),
                            weekNumber: Utils.getWeekNumber(weekStart),
                            year: weekStart.getFullYear(),
                            display: Utils.formatDateRange(weekStart, weekEnd)
                        },
                        weekStart: weekKey,
                        grossPay: 0,
                        totalDeductions: 0,
                        netPay: 0,
                        loadIds: [],
                        totalMiles: 0,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };
                    const id = await DataManager.addSettlement(settlement);
                    settlement.id = id;
                }

                // Only add if not already included
                if (!settlement.loadIds.includes(load.id)) {
                    settlement.grossPay = (parseFloat(settlement.grossPay) || 0) + driverPay;
                    settlement.totalMiles = (parseFloat(settlement.totalMiles) || 0) + miles;
                    settlement.loadIds.push(load.id);
                    settlement.netPay = settlement.grossPay - (parseFloat(settlement.totalDeductions) || 0);

                    await DataManager.updateSettlement(settlement.id, {
                        grossPay: settlement.grossPay,
                        totalMiles: settlement.totalMiles,
                        loadIds: settlement.loadIds,
                        netPay: settlement.netPay
                    });

                    // Link load back to settlement
                    await DataManager.updateLoad(load.id, { settlementId: settlement.id });

                    processed++;
                    console.log(`Processed ${processed}/${deliveredLoads.length}: ${load.loadNumber} → $${driverPay.toFixed(2)}`);
                }
            }

            // Refresh UI
            if (window.renderSettlements) window.renderSettlements();

            Utils.showNotification(
                `SYNC COMPLETE! ${processed} loads processed${skipped > 0 ? `, ${skipped} skipped` : ''}`,
                'success'
            );
        }

        // Expose to global scope
        window.syncAllDeliveredLoads = syncAllDeliveredLoads;

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('settlementModal');
            const createModal = document.getElementById('createSettlementModal');
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === createModal) {
                closeCreateModal();
            }
        }
    </script>
</body>

</html>